@@ -1,1859 +1,1018 @@
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회사 지출관리 시스템 - Firebase</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            font-weight: 300;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .auth-section {
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            margin-bottom: 20px;
        }

        .auth-section button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            margin: 0 10px;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .main-content {
            padding: 30px;
            display: none;
        }

        .main-content.authenticated {
            display: block;
        }
        
        .form-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
        }
        
        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        input, select, textarea {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .expense-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .expense-table th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .expense-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9em;
        }
        
        .expense-table tr:hover {
            background: #f8f9fa;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
            transition: transform 0.3s ease;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
        }
        
        .summary-card h4 {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .summary-card .amount {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        .delete-btn:hover {
            background: #c0392b;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .sync-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .sync-status.online {
            background: #d4edda;
            color: #155724;
        }

        .sync-status.offline {
            background: #f8d7da;
            color: #721c24;
        }

        .chart-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        
        .tab-btn:hover {
            color: #2980b9;
            background: #f8f9fa;
        }
        
        .chart-container {
            margin-top: 20px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
        }
        
        .chart-header h4 {
            color: #2c3e50;
            margin: 0;
        }
import React, { useState, useEffect } from 'react';
import { Calendar, Send, Check, AlertCircle, Eye, Trash2, ArrowRight, ArrowLeft, Filter, Users, CreditCard, Upload, FileSpreadsheet, Heart } from 'lucide-react';
import * as XLSX from 'xlsx';

const CouponSettlementSystem = () => {
  const [selectedMonth, setSelectedMonth] = useState('');
  const [data, setData] = useState([]);
  const [fileName, setFileName] = useState('');
  const [isFileUploaded, setIsFileUploaded] = useState(false);
  const [fileType, setFileType] = useState(''); // 'doljabi' 또는 'wedding'
  const [filteredData, setFilteredData] = useState([]);
  const [selectedCoupons, setSelectedCoupons] = useState({});
  const [groupedData, setGroupedData] = useState({});
  const [finalList, setFinalList] = useState({});
  const [duplicateItems, setDuplicateItems] = useState([]);
  const [selectedItems, setSelectedItems] = useState({});
  const [showDuplicatesOnly, setShowDuplicatesOnly] = useState(false);
  const [currentStep, setCurrentStep] = useState(1);
  const [messages, setMessages] = useState([]);
  const [isApproved, setIsApproved] = useState(false);

  // 컴포넌트 마운트 시 기본 엑셀 파일 읽기 시도
  useEffect(() => {
    loadDefaultExcelData();
  }, []);

  // 파일 타입 자동 감지
  const detectFileType = (jsonData) => {
    if (!jsonData || jsonData.length === 0) return 'unknown';
    
    const columns = Object.keys(jsonData[0]);
    
    // 돌잔치 파일 특징: 돌잔치날짜, 아가이름, 아빠이름 등
    const doljabiColumns = ['돌잔치날짜', '아가이름', '아빠이름', '엄마이름'];
    const doljabiScore = doljabiColumns.filter(col => columns.includes(col)).length;
    
    // 웨딩 파일 특징: 신랑이름, 신부이름 등
    const weddingColumns = ['신랑이름', '신부이름', '웨딩날짜', '결혼식날짜', '예식날짜'];
    const weddingScore = weddingColumns.filter(col => columns.includes(col)).length;
    
    if (doljabiScore >= 2) return 'doljabi';
    if (weddingScore >= 1) return 'wedding'; // 신랑이름, 신부이름 중 하나만 있어도 웨딩
    
    // 추가 로직: 구분 값으로 판단
    const sampleData = jsonData.slice(0, 10);
    const categoryValues = sampleData.map(row => row['구분']).filter(Boolean).join(' ').toLowerCase();
    
    if (categoryValues.includes('식전') || categoryValues.includes('포스터')) return 'wedding';
    if (categoryValues.includes('럽플릭스') || categoryValues.includes('메인')) return 'doljabi';
    
    return 'unknown';
  };

  const loadDefaultExcelData = async () => {
    try {
      const response = await window.fs.readFile('쿠폰 내역 1.xlsx');
      const workbook = XLSX.read(response);
      const worksheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(worksheet);
      
      const detectedType = detectFileType(jsonData);
      setData(jsonData);
      setFileName('쿠폰 내역 1.xlsx');
      setFileType(detectedType);
      setIsFileUploaded(true);
    } catch (error) {
      console.log('기본 파일을 찾을 수 없습니다. 파일을 업로드해주세요.');
      setIsFileUploaded(false);
    }
  };

  const handleFileUpload = async (event) => {
    const file = event.target.files[0];
    if (!file) return;

    try {
      const arrayBuffer = await file.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer);
      const worksheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(worksheet);
      
      const detectedType = detectFileType(jsonData);
      setData(jsonData);
      setFileName(file.name);
      setFileType(detectedType);
      setIsFileUploaded(true);
      
      // 기존 상태 초기화
      setFilteredData([]);
      setSelectedCoupons({});
      setGroupedData({});
      setFinalList({});
      setDuplicateItems([]);
      setSelectedItems({});
      setMessages([]);
      setIsApproved(false);
      setCurrentStep(1);
      
    } catch (error) {
      console.error('파일 읽기 오류:', error);
      alert('파일을 읽는 중 오류가 발생했습니다. Excel 파일인지 확인해주세요.');
    }
  };

  // 이전 단계로 돌아가기
  const goToPreviousStep = () => {
    if (currentStep > 1) {
      setCurrentStep(currentStep - 1);
    }
  };

  // 1단계: 월별 필터링
  const filterByMonth = () => {
    if (!selectedMonth) return;
    
    // 제외할 쿠폰코드 목록 (파일 타입별로 다름)
    let excludedCoupons = [];
    if (fileType === 'wedding') {
      excludedCoupons = [
        'STK110GA',
        'STK010Z', 
        '혀니웨딩짱',
        'STL3TV11',
        '알러뷰위위유',
        'STK210F',
        'LOVFLIX'
      ];
    } else {
      // 돌잔치 제외 쿠폰
      excludedCoupons = [
        'EVENTKN', 'STK220K', 'STF210F', 'STK210F',
        'LOVFLIX', 'INSTALF', 'PASTELTEST', 'BLOG28TS', 'S1TKFN244'
      ];
    }
    
    const [year, month] = selectedMonth.split('-');
    const filtered = data.filter(row => {
      const couponCode = row['쿠폰 코드'];
      if (excludedCoupons.includes(couponCode)) return false;
      
      // 웨딩의 경우 사용일자로 필터링 (돌잔치날짜가 없음)
      const dateField = fileType === 'wedding' ? '사용일자' : '돌잔치날짜';
      if (!row[dateField]) return false;
      
      const dateStr = row[dateField].toString();
      
      if (fileType === 'wedding') {
        // 사용일자 형식: "2025-08-28 18:59:57"
        const datePart = dateStr.split(' ')[0]; // "2025-08-28"
        const [rowYear, rowMonth] = datePart.split('-');
        return rowYear === year && rowMonth === month.padStart(2, '0');
      } else {
        // 돌잔치날짜 형식: "25-08-02"
        const parts = dateStr.split('-');
        if (parts.length === 3) {
          const rowYear = '20' + parts[0];
          const rowMonth = parts[1];
          return rowYear === year && rowMonth === month.padStart(2, '0');
        }
      }
      return false;
    });
    
    const filteredWithId = filtered.map((row, index) => ({
      ...row,
      filteredId: `filtered_${index}`
    }));
    
    setFilteredData(filteredWithId);
    
    // 쿠폰코드별로 그룹핑하여 선택 옵션 제공
    const couponGroups = {};
    filteredWithId.forEach(row => {
      const couponCode = row['쿠폰 코드'];
      if (!couponGroups[couponCode]) {
        couponGroups[couponCode] = [];
      }
      couponGroups[couponCode].push(row);
    });
    
    // 모든 쿠폰코드를 기본 선택 상태로 설정
    const initialSelected = {};
    Object.keys(couponGroups).forEach(couponCode => {
      initialSelected[couponCode] = true;
    });
    setSelectedCoupons(initialSelected);
    
    setCurrentStep(2);
  };

  // 2단계: 쿠폰코드별 그룹핑
  const groupData = () => {
    const selectedCouponList = Object.keys(selectedCoupons).filter(coupon => selectedCoupons[coupon]);
    const selectedData = filteredData.filter(row => selectedCouponList.includes(row['쿠폰 코드']));
    
    const grouped = {};
    
    selectedData.forEach(row => {
      const couponCode = row['쿠폰 코드'];
      const videoType = row['구분'];
      
      if (!grouped[couponCode]) {
        grouped[couponCode] = {
          couponCode: couponCode,
          customers: new Map()
        };
      }
      
      let customerKey;
      if (fileType === 'wedding') {
        // 웨딩: 신랑이름 + 신부이름으로 고객 식별
        customerKey = `${row['신랑이름']}_${row['신부이름']}`;
      } else {
        // 돌잔치: 아가이름 + 돌잔치날짜로 고객 식별
        customerKey = `${row['아가이름']}_${row['돌잔치날짜']}`;
      }
      
      if (!grouped[couponCode].customers.has(customerKey)) {
        const customerInfo = fileType === 'wedding' 
          ? {
              groomName: row['신랑이름'],
              brideName: row['신부이름'],
              managementNo: row['관리번호'],
              usageDate: row['사용일자'],
              videoTypes: new Set()
            }
          : {
              babyName: row['아가이름'],
              dadName: row['아빠이름'],
              momName: row['엄마이름'],
              partyDate: row['돌잔치날짜'],
              managementNo: row['관리번호'],
              videoTypes: new Set()
            };

        .chart-total {
            font-weight: bold;
            color: #e74c3c;
            font-size: 1.1em;
        }

        .canvas-wrapper {
            position: relative;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            min-height: 450px;
            padding: 20px;
        }

        .canvas-wrapper canvas {
            max-width: 100%;
            height: auto;
        }

        .editable-row {
            cursor: pointer;
        }

        .editable-row:hover {
            background: #e8f4f8 !important;
        }

        .edit-input {
            width: 100%;
            padding: 4px 8px;
            border: 2px solid #3498db;
            border-radius: 4px;
            font-size: 0.9em;
            background: white;
        }

        .edit-select {
            width: 100%;
            padding: 4px 8px;
            border: 2px solid #3498db;
            border-radius: 4px;
            font-size: 0.9em;
            background: white;
        }

        .toggle-section {
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 2px solid #3498db;
        }

        .toggle-section:hover {
            color: #2980b9;
        }

        .toggle-icon {
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }

        .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            transition: max-height 0.3s ease, opacity 0.3s ease;
            overflow: hidden;
        }
        grouped[couponCode].customers.set(customerKey, customerInfo);
      }
      
      grouped[couponCode].customers.get(customerKey).videoTypes.add(videoType);
    });
    
    const processedGrouped = {};
    Object.keys(grouped).forEach(couponCode => {
      const customers = Array.from(grouped[couponCode].customers.values()).map(customer => ({
        ...customer,
        videoTypes: Array.from(customer.videoTypes)
      }));
      
      processedGrouped[couponCode] = {
        couponCode: couponCode,
        customers: customers
      };
    });
    
    setGroupedData(processedGrouped);
    setCurrentStep(3);
  };

  // 3단계: 중복 감지
  const detectDuplicates = () => {
    const final = {};
    const duplicates = [];
    
    Object.keys(groupedData).forEach(couponCode => {
      const group = groupedData[couponCode];
      const processedCustomers = [];
      const names = new Map();
      
      group.customers.forEach((customer, index) => {
        let primaryName, secondaryName;
        
        if (fileType === 'wedding') {
          primaryName = customer.groomName;
          secondaryName = customer.brideName;
        } else {
          primaryName = customer.babyName;
          secondaryName = customer.momName;
        }
        
        const shortPrimaryName = primaryName ? primaryName.replace(/^[김이박최정강조윤장임]/, '') : '';
        const customerWithId = { ...customer, id: `${couponCode}_${index}` };
        
        // 중복 체크
        for (const [existingName, existingIndex] of names.entries()) {
          const existingShortName = existingName.replace(/^[김이박최정강조윤장임]/, '');
          if (shortPrimaryName === existingShortName || primaryName === existingName) {
            duplicates.push({
              couponCode: couponCode,
              customer1: processedCustomers[existingIndex],
              customer2: customerWithId,
              reason: shortPrimaryName === existingShortName ? '이름 유사' : '이름 동일'
            });
            break;
          }
        }
        
        names.set(primaryName, processedCustomers.length);
        processedCustomers.push(customerWithId);
      });
      
      if (processedCustomers.length > 0) {
        final[couponCode] = {
          ...group,
          customers: processedCustomers
        };
      }
    });
    
    setFinalList(final);
    setDuplicateItems(duplicates);
    
    // 초기 선택 상태 설정
    const initialSelected = {};
    Object.keys(final).forEach(couponCode => {
      final[couponCode].customers.forEach(customer => {
        initialSelected[customer.id] = true;
      });
    });
    
    // 중복 항목 중 두 번째 항목은 기본적으로 선택 해제
    duplicates.forEach(dup => {
      initialSelected[dup.customer2.id] = false;
    });
    
    setSelectedItems(initialSelected);
    setCurrentStep(4);
  };

  // 고객 이름 포매팅
  const formatCustomerName = (customer) => {
    if (fileType === 'wedding') {
      return `${customer.groomName} & ${customer.brideName}`;
    } else {
      if (customer.momName && customer.momName.trim()) {
        return `${customer.babyName}(${customer.momName})`;
      }
      return customer.babyName;
    }
  };

  // 4단계: 알림톡 메시지 생성
  const generateMessages = () => {
    const messageList = [];
    
    Object.keys(finalList).forEach(couponCode => {
      const selectedCustomers = finalList[couponCode].customers.filter(
        customer => selectedItems[customer.id]
      );
      
      if (selectedCustomers.length > 0) {
        const totalAmount = selectedCustomers.length * 5000;
        
        const serviceType = fileType === 'wedding' ? '웨딩영상' : '돌잔치영상';
        const message = `안녕하세요. 파스텔무비입니다. 건별 정산내용 보내드립니다. 이번달은 ${selectedCustomers.length}건의 ${serviceType} 제작건이 있었습니다. 최종 합계금액은 ${totalAmount.toLocaleString()}원이며 입금계좌는 아래와 같습니다.

국민은행 이용현 781601-00-231766 ${totalAmount.toLocaleString()}원

상세내역:
${selectedCustomers.map((customer) => 
  `${formatCustomerName(customer)}`
).join('\n')}`;

        messageList.push({
          couponCode: couponCode,
          message: message,
          totalCount: selectedCustomers.length,
          totalAmount: totalAmount
        });
      }
    });
    
    setMessages(messageList);
    setCurrentStep(5);
  };

  const getSystemTitle = () => {
    if (fileType === 'wedding') return '웨딩 정산 알림톡 시스템';
    if (fileType === 'doljabi') return '쿠폰 정산 알림톡 시스템';
    return '정산 알림톡 시스템';
  };

  const getSystemIcon = () => {
    if (fileType === 'wedding') return <Heart className="w-8 h-8 text-white" />;
    return <Send className="w-8 h-8 text-white" />;
  };

  const getSystemColor = () => {
    if (fileType === 'wedding') return 'from-pink-600 to-rose-600';
    return 'from-blue-600 to-indigo-600';
  };

  const stepNames = ['기간 설정', '쿠폰 선택', '중복 확인', '최종 검토', '메시지 발송'];

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50">
      <div className="container mx-auto px-6 py-8">
        {/* 헤더 */}
        <div className="text-center mb-8">
          <div className={`inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r ${getSystemColor()} rounded-2xl mb-4 shadow-lg`}>
            {getSystemIcon()}
          </div>
          <h1 className="text-4xl font-bold bg-gradient-to-r from-gray-900 to-gray-600 bg-clip-text text-transparent mb-3">
            {getSystemTitle()}
          </h1>
          <p className="text-gray-600 text-lg">
            {fileType === 'wedding' ? '완벽한 웨딩 정산 메시지 발송' : '간편하고 정확한 정산 메시지 발송'}
          </p>
          {fileType && (
            <div className={`inline-flex items-center gap-2 mt-2 px-4 py-2 rounded-full text-sm font-medium ${
              fileType === 'wedding' 
                ? 'bg-pink-100 text-pink-700' 
                : 'bg-blue-100 text-blue-700'
            }`}>
              {fileType === 'wedding' ? <Heart className="w-4 h-4" /> : <Send className="w-4 h-4" />}
              {fileType === 'wedding' ? '웨딩 파일' : '돌잔치 파일'} 자동 감지됨
            </div>
          )}
        </div>

        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 5px;
                border-radius: 15px;
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .form-section {
                padding: 20px 15px;
                margin-bottom: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        {/* 파일 업로드 섹션 */}
        <div className="bg-white/80 backdrop-blur-sm rounded-3xl p-6 mb-8 shadow-xl border border-white/20">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <div className="w-12 h-12 bg-gradient-to-r from-green-100 to-emerald-100 rounded-xl flex items-center justify-center">
                <FileSpreadsheet className="w-6 h-6 text-green-600" />
              </div>
              <div>
                <h3 className="text-lg font-bold text-gray-800">데이터 파일</h3>
                {isFileUploaded ? (
                  <div className="flex items-center gap-2 text-sm text-green-600">
                    <Check className="w-4 h-4" />
                    <span>{fileName} ({data.length.toLocaleString()}건)</span>
                  </div>
                ) : (
                  <p className="text-sm text-gray-600">엑셀 파일을 업로드해주세요</p>
                )}
              </div>
            </div>

            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            <div className="flex items-center gap-3">
              <input
                type="file"
                id="excel-upload"
                accept=".xlsx,.xls"
                onChange={handleFileUpload}
                className="hidden"
              />
              <label
                htmlFor="excel-upload"
                className="px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold rounded-xl hover:from-green-600 hover:to-emerald-700 transition-all duration-200 flex items-center gap-2 cursor-pointer shadow-lg hover:shadow-xl transform hover:scale-105"
              >
                <Upload className="w-4 h-4" />
                <span>{isFileUploaded ? '파일 변경' : '파일 업로드'}</span>
              </label>
            </div>
          </div>
        </div>

        {/* 진행 단계 */}
        {isFileUploaded && (
          <div className="bg-white/70 backdrop-blur-sm rounded-3xl p-8 mb-8 shadow-xl border border-white/20">
            <div className="flex items-center justify-between mb-6">
              {[1, 2, 3, 4, 5].map((step, index) => (
                <React.Fragment key={step}>
                  <div className="flex flex-col items-center">
                    <div className={`w-12 h-12 rounded-full flex items-center justify-center font-semibold text-sm transition-all duration-300 ${
                      currentStep >= step 
                        ? `bg-gradient-to-r ${getSystemColor()} text-white shadow-lg scale-105` 
                        : 'bg-gray-200 text-gray-500'
                    }`}>
                      {currentStep > step ? <Check className="w-5 h-5" /> : step}
                    </div>
                    <span className={`mt-3 text-xs font-medium ${
                      currentStep >= step 
                        ? fileType === 'wedding' ? 'text-pink-600' : 'text-blue-600'
                        : 'text-gray-400'
                    }`}>
                      {stepNames[step - 1]}
                    </span>
                  </div>
                  {index < 4 && (
                    <div className={`flex-1 h-0.5 mx-4 rounded-full transition-all duration-300 ${
                      currentStep > step 
                        ? `bg-gradient-to-r ${getSystemColor()}` 
                        : 'bg-gray-200'
                    }`} />
                  )}
                </React.Fragment>
              ))}
            </div>
          </div>
        )}

        {/* 1단계: 월 선택 */}
        {currentStep === 1 && isFileUploaded && (
          <div className="bg-white/80 backdrop-blur-sm rounded-3xl p-8 shadow-xl border border-white/20">
            <div className="flex items-center mb-6">
              <div className={`w-12 h-12 bg-gradient-to-r ${fileType === 'wedding' ? 'from-pink-100 to-rose-100' : 'from-blue-100 to-indigo-100'} rounded-xl flex items-center justify-center mr-4`}>
                <Calendar className={`w-6 h-6 ${fileType === 'wedding' ? 'text-pink-600' : 'text-blue-600'}`} />
              </div>
              <div>
                <h2 className="text-2xl font-bold text-gray-800">기간 설정</h2>
                <p className="text-gray-600">정산할 월을 선택해주세요</p>
              </div>
            </div>

            .summary-card {
                padding: 20px 15px;
            }
            <div className={`bg-gradient-to-r ${fileType === 'wedding' ? 'from-pink-50 to-rose-50' : 'from-blue-50 to-indigo-50'} rounded-2xl p-6 mb-6`}>
              <div className="flex flex-col sm:flex-row items-center gap-4">
                <input
                  type="month"
                  value={selectedMonth}
                  onChange={(e) => setSelectedMonth(e.target.value)}
                  className={`px-4 py-3 border-2 ${fileType === 'wedding' ? 'border-pink-200 focus:border-pink-500' : 'border-blue-200 focus:border-blue-500'} rounded-xl focus:outline-none transition-colors bg-white/50 backdrop-blur-sm text-lg font-medium`}
                />
                <button
                  onClick={filterByMonth}
                  disabled={!selectedMonth}
                  className={`px-8 py-3 bg-gradient-to-r ${getSystemColor()} text-white font-semibold rounded-xl hover:opacity-90 disabled:from-gray-300 disabled:to-gray-400 transition-all duration-200 flex items-center gap-2 shadow-lg hover:shadow-xl disabled:shadow-none transform hover:scale-105 disabled:scale-100`}
                >
                  <span>다음 단계</span>
                  <ArrowRight className="w-4 h-4" />
                </button>
              </div>
            </div>

            .summary-card .amount {
                font-size: 1.5em;
            }
            {data.length > 0 && (
              <div className="flex items-center gap-3 text-gray-600">
                <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <span>현재 파일에서 총 <span className="font-semibold text-gray-800">{data.length.toLocaleString()}</span>건의 데이터를 확인했습니다</span>
              </div>
            )}
          </div>
        )}

        {/* 2단계: 쿠폰코드 선택 */}
        {currentStep === 2 && isFileUploaded && (
          <div className="bg-white/80 backdrop-blur-sm rounded-3xl p-8 shadow-xl border border-white/20">
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center">
                <div className={`w-12 h-12 bg-gradient-to-r ${fileType === 'wedding' ? 'from-rose-100 to-pink-100' : 'from-emerald-100 to-green-100'} rounded-xl flex items-center justify-center mr-4`}>
                  <CreditCard className={`w-6 h-6 ${fileType === 'wedding' ? 'text-rose-600' : 'text-emerald-600'}`} />
                </div>
                <div>
                  <h2 className="text-2xl font-bold text-gray-800">쿠폰 선택</h2>
                  <p className="text-gray-600">정산할 쿠폰코드를 선택해주세요</p>
                </div>
              </div>
              
              <div className="flex gap-2">
                <button
                  onClick={() => {
                    const updatedSelection = {};
                    Object.keys(selectedCoupons).forEach(coupon => {
                      updatedSelection[coupon] = true;
                    });
                    setSelectedCoupons(updatedSelection);
                  }}
                  className={`px-4 py-2 ${fileType === 'wedding' ? 'bg-pink-100 text-pink-700 hover:bg-pink-200' : 'bg-blue-100 text-blue-700 hover:bg-blue-200'} rounded-xl transition-colors font-medium`}
                >
                  전체선택
                </button>
                <button
                  onClick={() => {
                    const updatedSelection = {};
                    Object.keys(selectedCoupons).forEach(coupon => {
                      updatedSelection[coupon] = false;
                    });
                    setSelectedCoupons(updatedSelection);
                  }}
                  className="px-4 py-2 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors font-medium"
                >
                  전체해제
                </button>
              </div>
            </div>

            .expense-table {
                font-size: 0.8em;
            }
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-8 max-h-96 overflow-y-auto">
              {Object.keys(selectedCoupons).map(couponCode => {
                const couponData = filteredData.filter(row => row['쿠폰 코드'] === couponCode);
                const uniqueCustomers = new Set();
                couponData.forEach(row => {
                  const customerKey = fileType === 'wedding' 
                    ? `${row['신랑이름']}_${row['신부이름']}`
                    : `${row['아가이름']}_${row['돌잔치날짜']}`;
                  uniqueCustomers.add(customerKey);
                });
                
                return (
                  <div key={couponCode} className={`group cursor-pointer transition-all duration-200 transform hover:scale-105 ${
                    selectedCoupons[couponCode] 
                      ? `bg-gradient-to-br ${fileType === 'wedding' ? 'from-pink-500 to-rose-600' : 'from-blue-500 to-indigo-600'} text-white shadow-lg` 
                      : 'bg-white hover:bg-gray-50 text-gray-700 shadow-md hover:shadow-lg'
                  } rounded-2xl p-5 border ${selectedCoupons[couponCode] ? (fileType === 'wedding' ? 'border-pink-200' : 'border-blue-200') : 'border-gray-200'}`}>
                    <label className="flex items-center cursor-pointer">
                      <input
                        type="checkbox"
                        checked={selectedCoupons[couponCode] || false}
                        onChange={() => {
                          setSelectedCoupons(prev => ({
                            ...prev,
                            [couponCode]: !prev[couponCode]
                          }));
                        }}
                        className="sr-only"
                      />
                      <div className="flex-1">
                        <div className="font-bold text-lg mb-2">{couponCode}</div>
                        <div className={`text-sm ${selectedCoupons[couponCode] ? (fileType === 'wedding' ? 'text-pink-100' : 'text-blue-100') : 'text-gray-500'}`}>
                          <div className="flex items-center gap-2">
                            <Users className="w-4 h-4" />
                            <span>{couponData.length}건 / {uniqueCustomers.size}명</span>
                          </div>
                        </div>
                      </div>
                      <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${
                        selectedCoupons[couponCode] 
                          ? 'border-white bg-white' 
                          : `border-gray-300 ${fileType === 'wedding' ? 'group-hover:border-pink-300' : 'group-hover:border-blue-300'}`
                      }`}>
                        {selectedCoupons[couponCode] && (
                          <Check className={`w-3 h-3 ${fileType === 'wedding' ? 'text-pink-600' : 'text-blue-600'}`} />
                        )}
                      </div>
                    </label>
                  </div>
                );
              })}
            </div>

            .expense-table th,
            .expense-table td {
                padding: 8px 6px;
            }

            .user-info {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>회사 지출관리 시스템</h1>
            <p>Firebase 기반 실시간 동기화로 더욱 안전한 지출 관리</p>
        </div>
        
        <!-- 인증 섹션 -->
        <div class="auth-section" id="authSection">
            <div class="loading" id="authLoading">Firebase 초기화 중...</div>
            <div id="signedOut" style="display: none;">
                <h3>로그인이 필요합니다</h3>
                <p>Google 계정으로 로그인하여 안전하게 지출 데이터를 관리하세요</p>
                <br>
                <button id="googleSignInBtn">Google 로그인</button>
            <div className={`bg-gradient-to-r ${fileType === 'wedding' ? 'from-rose-50 to-pink-50' : 'from-emerald-50 to-green-50'} rounded-2xl p-6 flex justify-between items-center`}>
              <button
                onClick={goToPreviousStep}
                className="px-6 py-3 bg-white border border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-all duration-200 flex items-center gap-2 shadow-sm hover:shadow-md"
              >
                <ArrowLeft className="w-4 h-4" />
                <span>이전 단계</span>
              </button>
              
              <div className="text-gray-700 flex items-center gap-4">
                <span className={`font-semibold ${fileType === 'wedding' ? 'text-rose-700' : 'text-emerald-700'}`}>
                  {Object.values(selectedCoupons).filter(Boolean).length}개
                </span>
                <span className="mx-2">/</span>
                <span className="text-gray-600">
                  총 {Object.keys(selectedCoupons).length}개 쿠폰 선택됨
                </span>
              </div>
              
              <button
                onClick={groupData}
                disabled={Object.values(selectedCoupons).filter(Boolean).length === 0}
                className={`px-8 py-3 bg-gradient-to-r ${fileType === 'wedding' ? 'from-rose-600 to-pink-600 hover:from-rose-700 hover:to-pink-700' : 'from-emerald-600 to-green-600 hover:from-emerald-700 hover:to-green-700'} text-white font-semibold rounded-xl disabled:from-gray-300 disabled:to-gray-400 transition-all duration-200 flex items-center gap-2 shadow-lg hover:shadow-xl disabled:shadow-none transform hover:scale-105 disabled:scale-100`}
              >
                <span>다음 단계</span>
                <ArrowRight className="w-4 h-4" />
              </button>
            </div>
          </div>
        )}

        {/* 3단계: 그룹핑 결과 */}
        {currentStep === 3 && isFileUploaded && (
          <div className="bg-white/80 backdrop-blur-sm rounded-3xl p-8 shadow-xl border border-white/20">
            <div className="flex items-center mb-6">
              <div className="w-12 h-12 bg-gradient-to-r from-amber-100 to-yellow-100 rounded-xl flex items-center justify-center mr-4">
                <Filter className="w-6 h-6 text-amber-600" />
              </div>
              <div>
                <h2 className="text-2xl font-bold text-gray-800">데이터 그룹핑</h2>
                <p className="text-gray-600">
                  {fileType === 'wedding' ? '웨딩 쿠폰코드별로 고객 데이터를 정리했습니다' : '쿠폰코드별로 고객 데이터를 정리했습니다'}
                </p>
              </div>
            </div>
            <div id="signedIn" style="display: none;">
                <div class="user-info">
                    <div>
                        <span id="userName">사용자</span>님 안녕하세요
                        <span class="sync-status" id="syncStatus">연결 확인 중...</span>
            
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8 max-h-96 overflow-y-auto">
              {Object.keys(groupedData).map(couponCode => (
                <div key={couponCode} className="bg-gradient-to-br from-white to-gray-50 rounded-2xl p-6 shadow-lg border border-gray-100 hover:shadow-xl transition-all duration-200">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="font-bold text-lg text-gray-800">{couponCode}</h3>
                    <div className={`px-3 py-1 ${fileType === 'wedding' ? 'bg-pink-100 text-pink-700' : 'bg-blue-100 text-blue-700'} rounded-full text-sm font-medium`}>
                      {groupedData[couponCode].customers.length}명
                    </div>
                  </div>
                  <div className={`text-sm text-gray-600 ${fileType === 'wedding' ? 'bg-pink-50' : 'bg-blue-50'} rounded-lg p-3`}>
                    <div className="flex items-center gap-2">
                      <div className={`w-2 h-2 ${fileType === 'wedding' ? 'bg-pink-500' : 'bg-blue-500'} rounded-full`}></div>
                      <span>{fileType === 'wedding' ? '식전, 인트로, 포스터 영상 통합' : '메인, 인트로, 엔딩영상 통합'}</span>
                    </div>
                    <button id="signOutBtn">로그아웃</button>
                    <div className="flex items-center gap-2 mt-1">
                      <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                      <span>같은 고객 여러 영상 = 1건</span>
                    </div>
                  </div>
                </div>
              ))}
            </div>
        </div>
        
        <div class="main-content" id="mainContent">
            <!-- 요약 카드 -->
            <div class="summary-cards">
                <div class="summary-card">
                    <h4>총 지출액</h4>
                    <div class="amount" id="totalExpense">₩0</div>
                </div>
                <div class="summary-card">
                    <h4>이번 달 지출</h4>
                    <div class="amount" id="monthlyExpense">₩0</div>
                </div>
                <div class="summary-card">
                    <h4>이번 달 일반지출</h4>
                    <div class="amount" id="nonFixedExpense">₩0</div>
            
            <div className="bg-gradient-to-r from-amber-50 to-yellow-50 rounded-2xl p-6 flex justify-between items-center">
              <button
                onClick={goToPreviousStep}
                className="px-6 py-3 bg-white border border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-all duration-200 flex items-center gap-2 shadow-sm hover:shadow-md"
              >
                <ArrowLeft className="w-4 h-4" />
                <span>이전 단계</span>
              </button>
              
              <button
                onClick={detectDuplicates}
                className="px-8 py-3 bg-gradient-to-r from-amber-600 to-yellow-600 text-white font-semibold rounded-xl hover:from-amber-700 hover:to-yellow-700 transition-all duration-200 flex items-center gap-2 shadow-lg hover:shadow-xl transform hover:scale-105"
              >
                <span>중복 감지 시작</span>
                <ArrowRight className="w-4 h-4" />
              </button>
            </div>
          </div>
        )}

        {/* 4단계와 5단계는 기존 코드와 동일하지만 색상만 조정 */}
        {currentStep === 4 && isFileUploaded && (
          <div className="bg-white/80 backdrop-blur-sm rounded-3xl p-8 shadow-xl border border-white/20">
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center">
                <div className={`w-12 h-12 bg-gradient-to-r ${fileType === 'wedding' ? 'from-rose-100 to-pink-100' : 'from-purple-100 to-indigo-100'} rounded-xl flex items-center justify-center mr-4`}>
                  <Users className={`w-6 h-6 ${fileType === 'wedding' ? 'text-rose-600' : 'text-purple-600'}`} />
                </div>
                <div class="summary-card">
                    <h4>등록된 항목</h4>
                    <div class="amount" id="totalItems">0건</div>
                <div>
                  <h2 className="text-2xl font-bold text-gray-800">중복 확인 및 최종 선택</h2>
                  <p className="text-gray-600">중복 항목을 확인하고 최종 정산 대상을 선택하세요</p>
                </div>
                <div class="summary-card">
                    <h4>월 고정비</h4>
                    <div class="amount" id="averageExpense">₩0</div>
              </div>
              
              {duplicateItems.length > 0 && (
                <div className="flex bg-gray-100 rounded-xl p-1">
                  <button
                    onClick={() => setShowDuplicatesOnly(false)}
                    className={`px-4 py-2 rounded-lg font-medium transition-all ${
                      !showDuplicatesOnly 
                        ? 'bg-white text-gray-800 shadow-sm' 
                        : 'text-gray-600 hover:text-gray-800'
                    }`}
                  >
                    전체 보기
                  </button>
                  <button
                    onClick={() => setShowDuplicatesOnly(true)}
                    className={`px-4 py-2 rounded-lg font-medium transition-all flex items-center gap-2 ${
                      showDuplicatesOnly 
                        ? 'bg-amber-500 text-white shadow-sm' 
                        : 'text-gray-600 hover:text-gray-800'
                    }`}
                  >
                    <AlertCircle className="w-4 h-4" />
                    중복만 보기 ({duplicateItems.length})
                  </button>
                </div>
              )}
            </div>

            <!-- 카테고리별 차트 -->
            <div class="form-section">
                <h3>카테고리별 지출 분석</h3>
                <div class="chart-tabs">
                    <button class="tab-btn active" onclick="showChart('thisMonth')">전체 지출</button>
                    <button class="tab-btn" onclick="showChart('nonFixed')">일반 지출 (고정비 제외)</button>
                    <button class="tab-btn" onclick="showChart('comparison')">지난 달과 비교</button>
            
            {/* 상단 통계 */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
              <div className={`bg-gradient-to-r ${fileType === 'wedding' ? 'from-pink-50 to-rose-50 border-pink-200' : 'from-blue-50 to-indigo-50 border-blue-200'} rounded-2xl p-4 border`}>
                <div className={`${fileType === 'wedding' ? 'text-pink-600' : 'text-blue-600'} text-sm font-medium`}>전체 고객</div>
                <div className={`text-2xl font-bold ${fileType === 'wedding' ? 'text-pink-800' : 'text-blue-800'}`}>
                  {Object.keys(finalList).reduce((acc, couponCode) => acc + finalList[couponCode].customers.length, 0)}명
                </div>
                
                <!-- 전체 지출 차트 -->
                <div id="thisMonthChart" class="chart-container">
                    <div class="chart-header">
                        <h4>이번 달 카테고리별 지출</h4>
                        <span id="thisMonthTotal" class="chart-total">총 지출: ₩0</span>
                    </div>
                    <div class="canvas-wrapper">
                        <canvas id="thisMonthCanvas" width="700" height="450"></canvas>
                    </div>
              </div>
              <div className="bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl p-4 border border-green-200">
                <div className="text-green-600 text-sm font-medium">선택된 고객</div>
                <div className="text-2xl font-bold text-green-800">
                  {Object.values(selectedItems).filter(Boolean).length}명
                </div>
                
                <!-- 고정비 제외 차트 -->
                <div id="nonFixedChart" class="chart-container" style="display: none;">
                    <div class="chart-header">
                        <h4>이번 달 일반 지출 (고정비 제외)</h4>
                        <span id="nonFixedTotal" class="chart-total">일반 지출: ₩0</span>
                    </div>
                    <div class="canvas-wrapper">
                        <canvas id="nonFixedCanvas" width="700" height="450"></canvas>
                    </div>
                </div>
                
                <!-- 지난 달 비교 차트 -->
                <div id="comparisonChart" class="chart-container" style="display: none;">
                    <div class="chart-header">
                        <h4>지난 달 대비 카테고리별 지출 비교</h4>
                        <div>
                            <span id="lastMonthTotal" class="chart-total">지난 달: ₩0</span>
                            <span id="thisMonthTotalComp" class="chart-total">이번 달: ₩0</span>
                        </div>
                    </div>
                    <div class="canvas-wrapper">
                        <canvas id="comparisonCanvas" width="1000" height="450"></canvas>
                    </div>
              </div>
              <div className="bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl p-4 border border-purple-200">
                <div className="text-purple-600 text-sm font-medium">예상 금액</div>
                <div className="text-2xl font-bold text-purple-800">
                  {(Object.values(selectedItems).filter(Boolean).length * 5000).toLocaleString()}원
                </div>
              </div>
            </div>

            <!-- 새 지출 등록 폼 -->
            <div class="form-section">
                <h3>새 지출 등록</h3>
                <form id="expenseForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date">날짜</label>
                            <input type="date" id="date" name="date" required>
                        </div>
                        <div class="form-group">
                            <label for="category">카테고리</label>
                            <select id="category" name="category" required>
                                <option value="">선택하세요</option>
                                <option value="사무용품">사무용품</option>
                                <option value="청첩장">청첩장</option>
                                <option value="식비">식비</option>
                                <option value="알바비">알바비</option>
                                <option value="액자">액자</option>
                                <option value="광고비">광고비</option>
                                <option value="마케팅">마케팅</option>
                                <option value="택배비">택배비</option>
                                <option value="이벤트">이벤트</option>
                                <option value="통신비">통신비</option>
                                <option value="임대료">임대료</option>
                                <option value="기타">기타</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="paymentMethod">결제 방식</label>
                            <select id="paymentMethod" name="paymentMethod" required>
                                <option value="">선택하세요</option>
                                <option value="법인카드">법인카드</option>
                                <option value="현금">현금</option>
                                <option value="계좌이체">계좌이체</option>
                                <option value="개인카드(정산)">개인카드(정산)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="description">지출 내역</label>
                            <input type="text" id="description" name="description" placeholder="구체적인 지출 내역을 입력하세요" required>
                        </div>
                        <div class="form-group">
                            <label for="amount">금액 (원)</label>
                            <input type="number" id="amount" name="amount" placeholder="0" min="0" required>
            {/* 중복 표시 및 전체 리스트는 기존과 동일 */}
            <div className="space-y-6 mb-8 max-h-96 overflow-y-auto">
              {Object.keys(finalList).map(couponCode => {
                const selectedCount = finalList[couponCode].customers.filter(c => selectedItems[c.id]).length;
                const totalCount = finalList[couponCode].customers.length;
                
                const duplicateCustomerIds = new Set();
                duplicateItems.forEach(dup => {
                  if (dup.couponCode === couponCode) {
                    duplicateCustomerIds.add(dup.customer1.id);
                    duplicateCustomerIds.add(dup.customer2.id);
                  }
                });
                
                return (
                  <div key={couponCode} className="bg-gradient-to-r from-white to-gray-50 rounded-2xl shadow-lg border border-gray-200 overflow-hidden">
                    <div className="bg-gradient-to-r from-gray-50 to-gray-100 p-6 border-b border-gray-200">
                      <div className="flex justify-between items-center">
                        <div className="flex items-center gap-4">
                          <h3 className="text-2xl font-bold text-gray-800">{couponCode}</h3>
                          <div className="flex gap-2">
                            <button
                              onClick={() => {
                                const updatedSelection = { ...selectedItems };
                                finalList[couponCode].customers.forEach(customer => {
                                  updatedSelection[customer.id] = true;
                                });
                                setSelectedItems(updatedSelection);
                              }}
                              className={`px-3 py-1.5 ${fileType === 'wedding' ? 'bg-pink-100 text-pink-700 hover:bg-pink-200' : 'bg-blue-100 text-blue-700 hover:bg-blue-200'} rounded-lg transition-colors text-sm font-medium`}
                            >
                              전체선택
                            </button>
                            <button
                              onClick={() => {
                                const updatedSelection = { ...selectedItems };
                                finalList[couponCode].customers.forEach(customer => {
                                  updatedSelection[customer.id] = false;
                                });
                                setSelectedItems(updatedSelection);
                              }}
                              className="px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium"
                            >
                              전체해제
                            </button>
                          </div>
                        </div>
                        <div class="form-group">
                            <label for="notes">비고</label>
                            <input type="text" id="notes" name="notes" placeholder="추가 메모 (선택사항)">
                        <div className={`bg-gradient-to-r ${getSystemColor()} text-white px-6 py-3 rounded-xl font-bold text-lg`}>
                          {selectedCount}/{totalCount}건 / {(selectedCount * 5000).toLocaleString()}원
                        </div>
                      </div>
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <button type="submit" class="btn btn-success">지출 등록</button>
                    <div className="p-6">
                      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
                        {finalList[couponCode].customers.map((customer) => {
                          const isDuplicate = duplicateCustomerIds.has(customer.id);
                          
                          return (
                            <div key={customer.id} className={`relative p-4 rounded-xl border-2 transition-all duration-200 ${
                              selectedItems[customer.id] 
                                ? isDuplicate
                                  ? 'border-amber-400 bg-amber-50 ring-2 ring-amber-200' 
                                  : `border-${fileType === 'wedding' ? 'pink' : 'blue'}-400 bg-${fileType === 'wedding' ? 'pink' : 'blue'}-50 ring-2 ring-${fileType === 'wedding' ? 'pink' : 'blue'}-200`
                                : isDuplicate
                                  ? 'border-amber-300 bg-amber-25 hover:bg-amber-50'
                                  : 'border-gray-200 bg-white hover:bg-gray-50 hover:border-gray-300'
                            }`}>
                              <label className="flex items-start cursor-pointer">
                                <input
                                  type="checkbox"
                                  checked={selectedItems[customer.id] || false}
                                  onChange={() => {
                                    setSelectedItems(prev => ({
                                      ...prev,
                                      [customer.id]: !prev[customer.id]
                                    }));
                                  }}
                                  className="w-4 h-4 text-blue-600 mr-3 mt-0.5"
                                />
                                <div className="flex-1 min-w-0">
                                  <div className="font-bold text-gray-800 truncate mb-1">
                                    {formatCustomerName(customer)}
                                  </div>
                                  <div className="text-sm text-gray-600 space-y-0.5">
                                    <div>{fileType === 'wedding' ? customer.usageDate?.split(' ')[0] : customer.partyDate}</div>
                                    <div className="text-xs text-gray-500">{customer.managementNo}</div>
                                    {customer.videoTypes && (
                                      <div className="flex flex-wrap gap-1 mt-1">
                                        {customer.videoTypes.map(type => (
                                          <span key={type} className="text-xs bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded">
                                            {type}
                                          </span>
                                        ))}
                                      </div>
                                    )}
                                  </div>
                                </div>
                              </label>
                              
                              {isDuplicate && (
                                <div className="absolute top-2 right-2 w-5 h-5 bg-amber-500 text-white rounded-full flex items-center justify-center">
                                  <AlertCircle className="w-3 h-3" />
                                </div>
                              )}
                              
                              {selectedItems[customer.id] && (
                                <div className={`absolute top-2 ${isDuplicate ? 'right-8' : 'right-2'} w-5 h-5 rounded-full flex items-center justify-center ${
                                  isDuplicate ? 'bg-amber-600' : `bg-${fileType === 'wedding' ? 'pink' : 'blue'}-500`
                                } text-white`}>
                                  <Check className="w-3 h-3" />
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                </form>
                  </div>
                );
              })}
            </div>

            <div className={`bg-gradient-to-r ${fileType === 'wedding' ? 'from-rose-50 to-pink-50' : 'from-purple-50 to-indigo-50'} rounded-2xl p-6 flex justify-between items-center`}>
              <button
                onClick={goToPreviousStep}
                className="px-6 py-3 bg-white border border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-all duration-200 flex items-center gap-2 shadow-sm hover:shadow-md"
              >
                <ArrowLeft className="w-4 h-4" />
                <span>이전 단계</span>
              </button>
              
              <button
                onClick={generateMessages}
                disabled={Object.values(selectedItems).filter(Boolean).length === 0}
                className={`px-8 py-3 bg-gradient-to-r ${fileType === 'wedding' ? 'from-rose-600 to-pink-600 hover:from-rose-700 hover:to-pink-700' : 'from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700'} text-white font-semibold rounded-xl disabled:from-gray-300 disabled:to-gray-400 transition-all duration-200 flex items-center gap-2 shadow-lg hover:shadow-xl disabled:shadow-none transform hover:scale-105 disabled:scale-100`}
              >
                <Eye className="w-4 h-4" />
                <span>알림톡 생성</span>
              </button>
            </div>
          </div>
        )}

        {/* 5단계: 알림톡 메시지 확인 및 발송 */}
        {currentStep === 5 && isFileUploaded && (
          <div className="bg-white/80 backdrop-blur-sm rounded-3xl p-8 shadow-xl border border-white/20">
            <div className="flex items-center mb-6">
              <div className={`w-12 h-12 bg-gradient-to-r ${fileType === 'wedding' ? 'from-pink-100 to-rose-100' : 'from-green-100 to-emerald-100'} rounded-xl flex items-center justify-center mr-4`}>
                <Send className={`w-6 h-6 ${fileType === 'wedding' ? 'text-pink-600' : 'text-green-600'}`} />
              </div>
              <div>
                <h2 className="text-2xl font-bold text-gray-800">메시지 발송</h2>
                <p className="text-gray-600">생성된 알림톡 메시지를 확인하고 발송하세요</p>
              </div>
            </div>

            <!-- 고정비 등록 폼 -->
            <div class="form-section">
                <h3>고정비 등록</h3>
                <form id="fixedExpenseForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fixedCategory">카테고리</label>
                            <select id="fixedCategory" name="fixedCategory" required>
                                <option value="">선택하세요</option>
                                <option value="임대료">임대료</option>
                                <option value="통신비">통신비</option>
                                <option value="세금">세금</option>
                                <option value="구독료">구독료</option>
                                <option value="유지보수비">유지보수비</option>
                                <option value="급여">급여</option>
                                <option value="기타 고정비">기타 고정비</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fixedDescription">고정비 내역</label>
                            <input type="text" id="fixedDescription" name="fixedDescription" placeholder="예: 사무실 임대료, 인터넷 요금 등" required>
                        </div>
                        <div class="form-group">
                            <label for="fixedAmount">월 금액 (원)</label>
                            <input type="number" id="fixedAmount" name="fixedAmount" placeholder="0" min="0" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fixedPaymentMethod">결제 방식</label>
                            <select id="fixedPaymentMethod" name="fixedPaymentMethod" required>
                                <option value="">선택하세요</option>
                                <option value="자동이체">자동이체</option>
                                <option value="법인카드">법인카드</option>
                                <option value="계좌이체">계좌이체</option>
                                <option value="현금">현금</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fixedStartDate">시작일</label>
                            <input type="date" id="fixedStartDate" name="fixedStartDate" required>
                        </div>
                        <div class="form-group">
                            <label for="fixedNotes">비고</label>
                            <input type="text" id="fixedNotes" name="fixedNotes" placeholder="추가 메모 (선택사항)">
            {!isApproved ? (
              <>
                <div className="space-y-6 mb-8 max-h-96 overflow-y-auto">
                  {messages.map((msg, idx) => (
                    <div key={idx} className="bg-gradient-to-r from-white to-gray-50 rounded-2xl p-6 shadow-lg border border-gray-200">
                      <div className="flex justify-between items-center mb-4">
                        <h3 className="text-xl font-bold text-gray-800">{msg.couponCode}</h3>
                        <div className={`bg-gradient-to-r ${fileType === 'wedding' ? 'from-pink-500 to-rose-600' : 'from-green-500 to-emerald-600'} text-white px-4 py-2 rounded-xl font-bold`}>
                          {msg.totalCount}건 / {msg.totalAmount.toLocaleString()}원
                        </div>
                      </div>
                      <div className="bg-gray-50 rounded-xl p-4 font-mono text-sm whitespace-pre-line text-gray-700 border border-gray-200">
                        {msg.message}
                      </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button type="submit" class="btn btn-success">고정비 등록</button>
                        <button type="button" id="generateMonthlyBtn" class="btn">이번 달 고정비 생성</button>
                    </div>
                </form>
            </div>
            
            <!-- 등록된 고정비 목록 -->
            <div class="form-section">
                <div class="toggle-section" onclick="toggleFixedExpenseList()">
                    <h3 style="margin: 0;">등록된 고정비</h3>
                    <span class="toggle-icon" id="fixedExpenseToggle">▼</span>
                  ))}
                </div>
                <div class="collapsible-content" id="fixedExpenseContent">
                    <div style="overflow-x: auto; margin-top: 20px;">
                        <table class="expense-table">
                            <thead>
                                <tr>
                                    <th>카테고리</th>
                                    <th>고정비 내역</th>
                                    <th>월 금액</th>
                                    <th>결제 방식</th>
                                    <th>시작일</th>
                                    <th>비고</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody id="fixedExpenseTableBody">
                            </tbody>
                        </table>
                
                <div className={`bg-gradient-to-r ${fileType === 'wedding' ? 'from-pink-50 to-rose-50' : 'from-green-50 to-emerald-50'} rounded-2xl p-6 flex justify-between items-center`}>
                  <button
                    onClick={goToPreviousStep}
                    className="px-6 py-3 bg-white border border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-all duration-200 flex items-center gap-2 shadow-sm hover:shadow-md"
                  >
                    <ArrowLeft className="w-4 h-4" />
                    <span>이전 단계</span>
                  </button>
                  
                  <button
                    onClick={() => setIsApproved(true)}
                    className={`px-12 py-4 bg-gradient-to-r ${fileType === 'wedding' ? 'from-pink-600 to-rose-600 hover:from-pink-700 hover:to-rose-700' : 'from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700'} text-white font-bold text-lg rounded-2xl transition-all duration-200 flex items-center gap-3 shadow-xl hover:shadow-2xl transform hover:scale-105`}
                  >
                    <Check className="w-6 h-6" />
                    <span>최종 승인 및 발송</span>
                  </button>
                </div>
              </>
            ) : (
              <div className="text-center py-16">
                <div className={`w-24 h-24 bg-gradient-to-r ${fileType === 'wedding' ? 'from-pink-400 to-rose-500' : 'from-green-400 to-emerald-500'} rounded-full flex items-center justify-center mx-auto mb-6 shadow-2xl animate-pulse`}>
                  <Check className="w-12 h-12 text-white" />
                </div>
                <h3 className={`text-4xl font-bold ${fileType === 'wedding' ? 'text-pink-600' : 'text-green-600'} mb-4`}>발송 완료!</h3>
                <p className="text-xl text-gray-600 mb-8">총 {messages.length}개 업체에 정산 알림톡이 발송되었습니다</p>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-w-4xl mx-auto">
                  {messages.map((msg, idx) => (
                    <div key={idx} className={`bg-gradient-to-r ${fileType === 'wedding' ? 'from-pink-100 to-rose-100 border-pink-200' : 'from-green-100 to-emerald-100 border-green-200'} p-4 rounded-2xl shadow-lg border`}>
                      <div className={`font-bold ${fileType === 'wedding' ? 'text-pink-800' : 'text-green-800'} text-lg`}>{msg.couponCode}</div>
                      <div className={`${fileType === 'wedding' ? 'text-pink-600' : 'text-green-600'}`}>{msg.totalCount}건 완료</div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        )}

        {/* 파일 업로드 안내 */}
        {!isFileUploaded && (
          <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-dashed border-blue-300 rounded-3xl p-12 text-center">
            <div className="w-20 h-20 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full flex items-center justify-center mx-auto mb-6">
              <Upload className="w-10 h-10 text-white" />
            </div>
            
            <!-- 지출 내역 테이블 -->
            <div class="form-section">
                <h3>지출 내역</h3>
                <div style="overflow-x: auto;">
                    <table class="expense-table">
                        <thead>
                            <tr>
                                <th>날짜</th>
                                <th>카테고리</th>
                                <th>지출 내역</th>
                                <th>금액</th>
                                <th>결제 방식</th>
                                <th>비고</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody id="expenseTableBody">
                        </tbody>
                    </table>
                </div>
            <h3 className="text-2xl font-bold text-gray-800 mb-4">엑셀 파일을 업로드하세요</h3>
            <p className="text-gray-600 mb-8">쿠폰 내역이 포함된 엑셀 파일을 선택하면 정산 작업을 시작할 수 있습니다</p>
            <div className="text-sm text-gray-500 bg-white rounded-xl p-4 inline-block">
              <div className="font-medium mb-2">지원 형식</div>
              <div className="flex items-center gap-4">
                <span>💒 웨딩 파일</span>
                <span>🎂 돌잔치 파일</span>
              </div>
              <div className="text-xs mt-2 text-gray-400">파일 형식은 자동으로 감지됩니다</div>
            </div>
        </div>
          </div>
        )}
      </div>
    </div>
  );
};

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase 설정 및 초기화
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, onSnapshot, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut as firebaseSignOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyAAXr7parhL6wQuUzy4MPvVhV6-J53wzcA",
            authDomain: "pastelmovie-cac7a.firebaseapp.com",
            databaseURL: "https://pastelmovie-cac7a-default-rtdb.firebaseio.com",
            projectId: "pastelmovie-cac7a",
            storageBucket: "pastelmovie-cac7a.firebasestorage.app",
            messagingSenderId: "543294016464",
            appId: "1:543294016464:web:47162285ca02d3cfb587d5",
            measurementId: "G-LK2Q13294B"
        };

        // Firebase 앱 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // 전역 변수
        let expenses = [];
        let fixedExpenses = [];
        let currentUser = null;
        let expenseUnsubscribe = null;
        let fixedExpenseUnsubscribe = null;
        let editingExpenseId = null;
        let editingFixedId = null;

        // 함수들을 전역으로 노출
        window.signInWithGoogle = signInWithGoogle;
        window.signOut = signOut;
        window.deleteExpenseById = deleteExpenseById;
        window.deleteFixedExpenseById = deleteFixedExpenseById;
        window.generateMonthlyExpenses = generateMonthlyExpenses;
        window.showChart = showChart;
        window.toggleFixedExpenseList = toggleFixedExpenseList;
        window.editExpense = editExpense;
        window.saveExpenseEdit = saveExpenseEdit;
        window.cancelExpenseEdit = cancelExpenseEdit;
        window.editFixedExpense = editFixedExpense;
        window.saveFixedExpenseEdit = saveFixedExpenseEdit;
        window.cancelFixedExpenseEdit = cancelFixedExpenseEdit;

        // 인증 상태 변경 감지
        onAuthStateChanged(auth, (user) => {
            const authLoading = document.getElementById('authLoading');
            const signedOut = document.getElementById('signedOut');
            const signedIn = document.getElementById('signedIn');
            const mainContent = document.getElementById('mainContent');
            const userName = document.getElementById('userName');

            authLoading.style.display = 'none';

            if (user) {
                currentUser = user;
                signedOut.style.display = 'none';
                signedIn.style.display = 'block';
                mainContent.classList.add('authenticated');
                userName.textContent = user.displayName || user.email;
                
                updateSyncStatus('online');
                setupRealtimeListeners();
                initializePage();
                
                console.log('사용자 로그인:', user.email);
            } else {
                currentUser = null;
                signedOut.style.display = 'block';
                signedIn.style.display = 'none';
                mainContent.classList.remove('authenticated');
                
                if (expenseUnsubscribe) expenseUnsubscribe();
                if (fixedExpenseUnsubscribe) fixedExpenseUnsubscribe();
                
                updateSyncStatus('offline');
                
                setTimeout(() => {
                    const googleSignInBtn = document.getElementById('googleSignInBtn');
                    const signOutBtn = document.getElementById('signOutBtn');
                    
                    if (googleSignInBtn) {
                        googleSignInBtn.addEventListener('click', signInWithGoogle);
                    }
                    
                    if (signOutBtn) {
                        signOutBtn.addEventListener('click', signOut);
                    }
                }, 100);
                
                console.log('사용자 로그아웃');
            }
        });

        // Google 로그인
        async function signInWithGoogle() {
            try {
                const result = await signInWithPopup(auth, provider);
                console.log('로그인 성공:', result.user.email);
            } catch (error) {
                console.error('로그인 오류:', error);
                alert('로그인 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 로그아웃
        async function signOut() {
            try {
                await firebaseSignOut(auth);
                expenses = [];
                fixedExpenses = [];
                console.log('로그아웃 성공');
            } catch (error) {
                console.error('로그아웃 오류:', error);
                alert('로그아웃 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 동기화 상태 업데이트
        function updateSyncStatus(status) {
            const syncStatus = document.getElementById('syncStatus');
            if (status === 'online') {
                syncStatus.textContent = '온라인';
                syncStatus.className = 'sync-status online';
            } else {
                syncStatus.textContent = '오프라인';
                syncStatus.className = 'sync-status offline';
            }
        }

        // 실시간 리스너 설정
        function setupRealtimeListeners() {
            if (!currentUser) return;

            const expensesQuery = query(
                collection(db, `users/${currentUser.uid}/expenses`),
                orderBy('date', 'desc')
            );

            expenseUnsubscribe = onSnapshot(expensesQuery, (snapshot) => {
                expenses = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                renderExpenseTable();
                updateSummary();
                console.log('지출 데이터 실시간 업데이트:', expenses.length, '건');
            });

            const fixedExpensesQuery = query(
                collection(db, `users/${currentUser.uid}/fixedExpenses`),
                orderBy('startDate', 'desc')
            );

            fixedExpenseUnsubscribe = onSnapshot(fixedExpensesQuery, (snapshot) => {
                fixedExpenses = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                renderFixedExpenseTable();
                updateSummary();
                console.log('고정비 데이터 실시간 업데이트:', fixedExpenses.length, '건');
            });
        }

        // 페이지 초기화
        function initializePage() {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('date');
            const fixedStartDateInput = document.getElementById('fixedStartDate');
            
            if (dateInput) dateInput.value = today;
            if (fixedStartDateInput) fixedStartDateInput.value = today;
            
            const expenseForm = document.getElementById('expenseForm');
            const fixedExpenseForm = document.getElementById('fixedExpenseForm');
            const generateMonthlyBtn = document.getElementById('generateMonthlyBtn');
            
            if (expenseForm) {
                expenseForm.removeEventListener('submit', handleFormSubmit);
                expenseForm.addEventListener('submit', handleFormSubmit);
            }
            
            if (fixedExpenseForm) {
                fixedExpenseForm.removeEventListener('submit', handleFixedExpenseSubmit);
                fixedExpenseForm.addEventListener('submit', handleFixedExpenseSubmit);
            }
            
            if (generateMonthlyBtn) {
                generateMonthlyBtn.onclick = generateMonthlyExpenses;
            }
        }

        // 지출 등록 폼 제출 처리
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            if (!currentUser) {
                alert('로그인이 필요합니다.');
                return;
            }
            
            const formData = new FormData(e.target);
            const expense = {
                date: formData.get('date'),
                category: formData.get('category'),
                description: formData.get('description'),
                amount: parseInt(formData.get('amount')),
                paymentMethod: formData.get('paymentMethod'),
                notes: formData.get('notes') || '',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            try {
                await addDoc(collection(db, `users/${currentUser.uid}/expenses`), expense);
                
                document.getElementById('expenseForm').reset();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('date').value = today;
                
                showSuccessMessage('지출이 성공적으로 등록되었습니다!');
                console.log('지출 등록 완료:', expense);
            } catch (error) {
                console.error('지출 등록 오류:', error);
                alert('지출 등록 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 고정비 등록 폼 제출 처리
        async function handleFixedExpenseSubmit(e) {
            e.preventDefault();
            
            if (!currentUser) {
                alert('로그인이 필요합니다.');
                return;
            }
            
            const formData = new FormData(e.target);
            const fixedExpense = {
                category: formData.get('fixedCategory'),
                description: formData.get('fixedDescription'),
                amount: parseInt(formData.get('fixedAmount')),
                paymentMethod: formData.get('fixedPaymentMethod'),
                startDate: formData.get('fixedStartDate'),
                notes: formData.get('fixedNotes') || '',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            try {
                await addDoc(collection(db, `users/${currentUser.uid}/fixedExpenses`), fixedExpense);
                
                document.getElementById('fixedExpenseForm').reset();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('fixedStartDate').value = today;
                
                showSuccessMessage('고정비가 성공적으로 등록되었습니다!');
                console.log('고정비 등록 완료:', fixedExpense);
            } catch (error) {
                console.error('고정비 등록 오류:', error);
                alert('고정비 등록 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 지출 삭제
        async function deleteExpenseById(expenseId) {
            if (!currentUser) {
                alert('로그인이 필요합니다.');
                return;
            }
            
            if (!expenseId) {
                alert('잘못된 ID입니다.');
                return;
            }
            
            if (confirm('정말 삭제하시겠습니까?')) {
                try {
                    await deleteDoc(doc(db, `users/${currentUser.uid}/expenses`, expenseId));
                    showSuccessMessage('지출이 삭제되었습니다.');
                    console.log('지출 삭제 완료:', expenseId);
                } catch (error) {
                    console.error('지출 삭제 오류:', error);
                    alert('지출 삭제 중 오류가 발생했습니다: ' + error.message);
                }
            }
        }

        // 고정비 삭제
        async function deleteFixedExpenseById(fixedId) {
            if (!currentUser) {
                alert('로그인이 필요합니다.');
                return;
            }
            
            if (!fixedId) {
                alert('잘못된 ID입니다.');
                return;
            }
            
            if (confirm('정말 삭제하시겠습니까?')) {
                try {
                    await deleteDoc(doc(db, `users/${currentUser.uid}/fixedExpenses`, fixedId));
                    showSuccessMessage('고정비가 삭제되었습니다.');
                    console.log('고정비 삭제 완료:', fixedId);
                } catch (error) {
                    console.error('고정비 삭제 오류:', error);
                    alert('고정비 삭제 중 오류가 발생했습니다: ' + error.message);
                }
            }
        }

        // 이번 달 고정비 생성 (당월 1일로 확실히 수정)
        async function generateMonthlyExpenses() {
            if (!currentUser) {
                alert('로그인이 필요합니다.');
                return;
            }
            
            if (fixedExpenses.length === 0) {
                alert('등록된 고정비가 없습니다.');
                return;
            }
            
            const now = new Date();
            const thisMonth = now.getMonth();
            const thisYear = now.getFullYear();
            
            // 확실히 이번 달 1일로 설정
            const firstDayOfThisMonth = `${thisYear}-${(thisMonth + 1).toString().padStart(2, '0')}-01`;
            console.log('생성할 고정비 날짜:', firstDayOfThisMonth);
            
            // 이번 달에 이미 생성된 고정비들을 체크
            const existingThisMonth = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === thisMonth && 
                       expenseDate.getFullYear() === thisYear &&
                       expense.notes && expense.notes.includes('[고정비 자동생성]');
            });
            
            // 각 고정비별로 중복 체크를 위한 매핑 생성
            const existingFixedExpensesByDescription = new Set(
                existingThisMonth.map(expense => `${expense.category}-${expense.description}-${expense.amount}`)
            );
            
            let addedCount = 0;
            let skippedCount = 0;
            
            for (const fixed of fixedExpenses) {
                const fixedStartDate = new Date(fixed.startDate);
                
                if (fixedStartDate <= now) {
                    // 중복 체크용 키 생성
                    const duplicateCheckKey = `${fixed.category}-${fixed.description}-${fixed.amount}`;
                    
                    // 이미 존재하는지 확인
                    if (existingFixedExpensesByDescription.has(duplicateCheckKey)) {
                        skippedCount++;
                        console.log('중복된 고정비 건너뛰기:', fixed.description);
                        continue;
                    }
                    
                    const expense = {
                        date: firstDayOfThisMonth, // YYYY-MM-01 형식으로 확실히 1일 설정
                        category: fixed.category,
                        description: fixed.description,
                        amount: fixed.amount,
                        paymentMethod: fixed.paymentMethod,
                        notes: fixed.notes ? `${fixed.notes} [고정비 자동생성]` : '[고정비 자동생성]',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    console.log('추가할 고정비 데이터:', expense);
                    
                    try {
                        await addDoc(collection(db, `users/${currentUser.uid}/expenses`), expense);
                        addedCount++;
                        // 추가 후 중복 체크 목록에 추가
                        existingFixedExpensesByDescription.add(duplicateCheckKey);
                        console.log('고정비 성공적으로 추가:', fixed.description, '날짜:', firstDayOfThisMonth);
                    } catch (error) {
                        console.error('고정비 생성 오류:', error);
                        alert('고정비 생성 중 오류가 발생했습니다: ' + error.message);
                        return;
                    }
                }
            }
            
            // 결과 메시지 표시
            let resultMessage = '';
            if (addedCount > 0) {
                resultMessage += `${addedCount}개의 고정비가 ${firstDayOfThisMonth} 지출로 추가되었습니다.`;
            }
            if (skippedCount > 0) {
                if (resultMessage) resultMessage += '\n';
                resultMessage += `${skippedCount}개의 고정비는 이미 존재하여 건너뛰었습니다.`;
            }
            
            if (addedCount > 0) {
                showSuccessMessage(resultMessage);
                console.log('고정비 생성 완료 - 추가:', addedCount, '개, 건너뜀:', skippedCount, '개');
            } else if (skippedCount > 0) {
                alert('모든 고정비가 이미 이번 달에 생성되어 있습니다.');
            } else {
                alert('추가할 고정비가 없습니다.');
            }
        }

        // 고정비 목록 토글
        function toggleFixedExpenseList() {
            const content = document.getElementById('fixedExpenseContent');
            const toggle = document.getElementById('fixedExpenseToggle');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.classList.remove('collapsed');
                toggle.textContent = '▼';
            } else {
                content.classList.add('collapsed');
                toggle.classList.add('collapsed');
                toggle.textContent = '▶';
            }
        }

        // 지출 수정 시작
        function editExpense(expenseId) {
            if (editingExpenseId) {
                cancelExpenseEdit();
            }
            editingExpenseId = expenseId;
            
            const expense = expenses.find(e => e.id === expenseId);
            if (!expense) return;
            
            const row = document.querySelector(`[data-expense-id="${expenseId}"]`).closest('tr');
            const cells = row.querySelectorAll('td');
            
            cells[0].innerHTML = `<input type="date" class="edit-input" value="${expense.date}" id="edit-date">`;
            cells[1].innerHTML = `
                <select class="edit-select" id="edit-category">
                    <option value="사무용품" ${expense.category === '사무용품' ? 'selected' : ''}>사무용품</option>
                    <option value="청첩장" ${expense.category === '청첩장' ? 'selected' : ''}>청첩장</option>
                    <option value="식비" ${expense.category === '식비' ? 'selected' : ''}>식비</option>
                    <option value="알바비" ${expense.category === '알바비' ? 'selected' : ''}>알바비</option>
                    <option value="액자" ${expense.category === '액자' ? 'selected' : ''}>액자</option>
                    <option value="광고비" ${expense.category === '광고비' ? 'selected' : ''}>광고비</option>
                    <option value="마케팅" ${expense.category === '마케팅' ? 'selected' : ''}>마케팅</option>
                    <option value="택배비" ${expense.category === '택배비' ? 'selected' : ''}>택배비</option>
                    <option value="이벤트" ${expense.category === '이벤트' ? 'selected' : ''}>이벤트</option>
                    <option value="통신비" ${expense.category === '통신비' ? 'selected' : ''}>통신비</option>
                    <option value="임대료" ${expense.category === '임대료' ? 'selected' : ''}>임대료</option>
                    <option value="기타" ${expense.category === '기타' ? 'selected' : ''}>기타</option>
                </select>
            `;
            cells[2].innerHTML = `<input type="text" class="edit-input" value="${expense.description}" id="edit-description">`;
            cells[3].innerHTML = `<input type="number" class="edit-input" value="${expense.amount}" id="edit-amount">`;
            cells[4].innerHTML = `
                <select class="edit-select" id="edit-paymentMethod">
                    <option value="법인카드" ${expense.paymentMethod === '법인카드' ? 'selected' : ''}>법인카드</option>
                    <option value="현금" ${expense.paymentMethod === '현금' ? 'selected' : ''}>현금</option>
                    <option value="계좌이체" ${expense.paymentMethod === '계좌이체' ? 'selected' : ''}>계좌이체</option>
                    <option value="개인카드(정산)" ${expense.paymentMethod === '개인카드(정산)' ? 'selected' : ''}>개인카드(정산)</option>
                </select>
            `;
            cells[5].innerHTML = `<input type="text" class="edit-input" value="${expense.notes}" id="edit-notes">`;
            cells[6].innerHTML = `
                <button class="btn" style="margin-right: 5px; padding: 5px 10px; font-size: 0.8em;" onclick="saveExpenseEdit('${expenseId}')">저장</button>
                <button class="btn-danger" style="padding: 5px 10px; font-size: 0.8em;" onclick="cancelExpenseEdit()">취소</button>
            `;
        }

        // 지출 수정 저장
        async function saveExpenseEdit(expenseId) {
            const updatedExpense = {
                date: document.getElementById('edit-date').value,
                category: document.getElementById('edit-category').value,
                description: document.getElementById('edit-description').value,
                amount: parseInt(document.getElementById('edit-amount').value),
                paymentMethod: document.getElementById('edit-paymentMethod').value,
                notes: document.getElementById('edit-notes').value,
                updatedAt: new Date().toISOString()
            };

            try {
                await updateDoc(doc(db, `users/${currentUser.uid}/expenses`, expenseId), updatedExpense);
                editingExpenseId = null;
                showSuccessMessage('지출이 수정되었습니다.');
                console.log('지출 수정 완료:', expenseId);
            } catch (error) {
                console.error('지출 수정 오류:', error);
                alert('지출 수정 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 지출 수정 취소
        function cancelExpenseEdit() {
            editingExpenseId = null;
            renderExpenseTable();
        }

        // 고정비 수정 시작
        function editFixedExpense(fixedId) {
            if (editingFixedId) {
                cancelFixedExpenseEdit();
            }
            editingFixedId = fixedId;
            
            const fixed = fixedExpenses.find(f => f.id === fixedId);
            if (!fixed) return;
            
            const row = document.querySelector(`[data-fixed-id="${fixedId}"]`).closest('tr');
            const cells = row.querySelectorAll('td');
            
            cells[0].innerHTML = `
                <select class="edit-select" id="edit-fixed-category">
                    <option value="임대료" ${fixed.category === '임대료' ? 'selected' : ''}>임대료</option>
                    <option value="통신비" ${fixed.category === '통신비' ? 'selected' : ''}>통신비</option>
                    <option value="세금" ${fixed.category === '세금' ? 'selected' : ''}>세금</option>
                    <option value="구독료" ${fixed.category === '구독료' ? 'selected' : ''}>구독료</option>
                    <option value="유지보수비" ${fixed.category === '유지보수비' ? 'selected' : ''}>유지보수비</option>
                    <option value="급여" ${fixed.category === '급여' ? 'selected' : ''}>급여</option>
                    <option value="기타 고정비" ${fixed.category === '기타 고정비' ? 'selected' : ''}>기타 고정비</option>
                </select>
            `;
            cells[1].innerHTML = `<input type="text" class="edit-input" value="${fixed.description}" id="edit-fixed-description">`;
            cells[2].innerHTML = `<input type="number" class="edit-input" value="${fixed.amount}" id="edit-fixed-amount">`;
            cells[3].innerHTML = `
                <select class="edit-select" id="edit-fixed-paymentMethod">
                    <option value="자동이체" ${fixed.paymentMethod === '자동이체' ? 'selected' : ''}>자동이체</option>
                    <option value="법인카드" ${fixed.paymentMethod === '법인카드' ? 'selected' : ''}>법인카드</option>
                    <option value="계좌이체" ${fixed.paymentMethod === '계좌이체' ? 'selected' : ''}>계좌이체</option>
                    <option value="현금" ${fixed.paymentMethod === '현금' ? 'selected' : ''}>현금</option>
                </select>
            `;
            cells[4].innerHTML = `<input type="date" class="edit-input" value="${fixed.startDate}" id="edit-fixed-startDate">`;
            cells[5].innerHTML = `<input type="text" class="edit-input" value="${fixed.notes}" id="edit-fixed-notes">`;
            cells[6].innerHTML = `
                <button class="btn" style="margin-right: 5px; padding: 5px 10px; font-size: 0.8em;" onclick="saveFixedExpenseEdit('${fixedId}')">저장</button>
                <button class="btn-danger" style="padding: 5px 10px; font-size: 0.8em;" onclick="cancelFixedExpenseEdit()">취소</button>
            `;
        }

        // 고정비 수정 저장
        async function saveFixedExpenseEdit(fixedId) {
            const updatedFixed = {
                category: document.getElementById('edit-fixed-category').value,
                description: document.getElementById('edit-fixed-description').value,
                amount: parseInt(document.getElementById('edit-fixed-amount').value),
                paymentMethod: document.getElementById('edit-fixed-paymentMethod').value,
                startDate: document.getElementById('edit-fixed-startDate').value,
                notes: document.getElementById('edit-fixed-notes').value,
                updatedAt: new Date().toISOString()
            };

            try {
                await updateDoc(doc(db, `users/${currentUser.uid}/fixedExpenses`, fixedId), updatedFixed);
                editingFixedId = null;
                showSuccessMessage('고정비가 수정되었습니다.');
                console.log('고정비 수정 완료:', fixedId);
            } catch (error) {
                console.error('고정비 수정 오류:', error);
                alert('고정비 수정 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 고정비 수정 취소
        function cancelFixedExpenseEdit() {
            editingFixedId = null;
            renderFixedExpenseTable();
        }

        // 테이블 렌더링
        function renderExpenseTable() {
            const tbody = document.getElementById('expenseTableBody');
            
            tbody.innerHTML = expenses.map((expense) => {
                return `
                    <tr class="editable-row" ondblclick="editExpense('${expense.id}')" title="더블클릭하여 수정">
                        <td>${new Date(expense.date).toLocaleDateString('ko-KR')}</td>
                        <td><span style="padding: 4px 8px; background: #e3f2fd; border-radius: 4px; font-size: 0.8em;">${expense.category}</span></td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${expense.description}</td>
                        <td style="text-align: right; font-weight: bold; color: #e74c3c;">₩${expense.amount.toLocaleString()}</td>
                        <td>${expense.paymentMethod}</td>
                        <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">${expense.notes}</td>
                        <td>
                            <button class="delete-btn" data-expense-id="${expense.id}">삭제</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const expenseId = e.target.getAttribute('data-expense-id');
                    deleteExpenseById(expenseId);
                });
            });
        }

        function renderFixedExpenseTable() {
            const tbody = document.getElementById('fixedExpenseTableBody');
            
            tbody.innerHTML = fixedExpenses.map((fixed) => {
                return `
                    <tr class="editable-row" ondblclick="editFixedExpense('${fixed.id}')" title="더블클릭하여 수정">
                        <td><span style="padding: 4px 8px; background: #fff3cd; border-radius: 4px; font-size: 0.8em;">${fixed.category}</span></td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${fixed.description}</td>
                        <td style="text-align: right; font-weight: bold; color: #f39c12;">₩${fixed.amount.toLocaleString()}</td>
                        <td>${fixed.paymentMethod}</td>
                        <td>${new Date(fixed.startDate).toLocaleDateString('ko-KR')}</td>
                        <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">${fixed.notes}</td>
                        <td>
                            <button class="delete-btn" data-fixed-id="${fixed.id}">삭제</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const fixedId = e.target.getAttribute('data-fixed-id');
                    deleteFixedExpenseById(fixedId);
                });
            });
        }

        // 요약 업데이트
        function updateSummary() {
            const total = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            
            const now = new Date();
            const thisMonthExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === now.getMonth() && 
                       expenseDate.getFullYear() === now.getFullYear();
            });
            
            const thisMonth = thisMonthExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            
            // 고정비 제외 계산
            const thisMonthNonFixed = thisMonthExpenses.filter(expense => 
                !expense.notes || !expense.notes.includes('[고정비 자동생성]')
            ).reduce((sum, expense) => sum + expense.amount, 0);
            
            const monthlyFixedTotal = fixedExpenses.reduce((sum, fixed) => sum + fixed.amount, 0);
            
            document.getElementById('totalExpense').textContent = `₩${total.toLocaleString()}`;
            document.getElementById('monthlyExpense').textContent = `₩${thisMonth.toLocaleString()}`;
            document.getElementById('nonFixedExpense').textContent = `₩${thisMonthNonFixed.toLocaleString()}`;
            document.getElementById('totalItems').textContent = `${expenses.length}건`;
            document.getElementById('averageExpense').textContent = `₩${monthlyFixedTotal.toLocaleString()}`;
            
            updateCharts();
        }

        // 차트 탭 전환
        function showChart(type) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('thisMonthChart').style.display = 'none';
            document.getElementById('nonFixedChart').style.display = 'none';
            document.getElementById('comparisonChart').style.display = 'none';
            
            if (type === 'thisMonth') {
                document.getElementById('thisMonthChart').style.display = 'block';
            } else if (type === 'nonFixed') {
                document.getElementById('nonFixedChart').style.display = 'block';
            } else {
                document.getElementById('comparisonChart').style.display = 'block';
            }
            
            updateCharts();
        }

        // 차트 업데이트
        function updateCharts() {
            drawThisMonthChart();
            drawNonFixedChart();
            drawComparisonChart();
        }

        // 이번 달 전체 차트 그리기
        function drawThisMonthChart() {
            const thisMonthData = getThisMonthData();
            const categoryData = thisMonthData.categories;
            const total = thisMonthData.total;
            const monthInfo = thisMonthData.monthInfo;

            document.getElementById('thisMonthTotal').textContent = 
                `${monthInfo} 총 지출: ₩${total.toLocaleString()}`;

            drawPieChart('thisMonthCanvas', categoryData);
        }

        // 고정비 제외 차트 그리기
        function drawNonFixedChart() {
            const nonFixedData = getNonFixedMonthData();
            const categoryData = nonFixedData.categories;
            const total = nonFixedData.total;
            const monthInfo = nonFixedData.monthInfo;

            document.getElementById('nonFixedTotal').textContent = 
                `${monthInfo} 일반 지출: ₩${total.toLocaleString()}`;

            drawPieChart('nonFixedCanvas', categoryData);
        }

        // 지난 달 비교 차트 그리기
        function drawComparisonChart() {
            const comparisonData = getComparisonData();
            
            const thisMonthData = comparisonData.thisMonth.categories;
            const lastMonthData = comparisonData.lastMonth.categories;
            const thisMonthTotal = comparisonData.thisMonth.total;
            const lastMonthTotal = comparisonData.lastMonth.total;

            document.getElementById('thisMonthTotalComp').textContent = 
                `${comparisonData.thisMonth.monthInfo}: ₩${thisMonthTotal.toLocaleString()}`;
            document.getElementById('lastMonthTotal').textContent = 
                `${comparisonData.lastMonth.monthInfo}: ₩${lastMonthTotal.toLocaleString()}`;

            drawComparisonBarChart('comparisonCanvas', lastMonthData, thisMonthData);
        }

        // 이번 달 전체 데이터 가져오기
        function getThisMonthData() {
            if (expenses.length === 0) {
                return {
                    categories: {},
                    total: 0,
                    monthInfo: '이번 달'
                };
            }

            const now = new Date();
            const targetYear = now.getFullYear();
            const targetMonth = now.getMonth();

            const filteredExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === targetMonth && 
                       expenseDate.getFullYear() === targetYear;
            });

            const categoryData = {};
            let total = 0;

            filteredExpenses.forEach(expense => {
                categoryData[expense.category] = (categoryData[expense.category] || 0) + expense.amount;
                total += expense.amount;
            });

            const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];
            const monthInfo = `${targetYear}년 ${monthNames[targetMonth]}`;

            return {
                categories: categoryData,
                total: total,
                monthInfo: monthInfo
            };
        }

        // 고정비 제외 데이터 가져오기
        function getNonFixedMonthData() {
            if (expenses.length === 0) {
                return {
                    categories: {},
                    total: 0,
                    monthInfo: '이번 달'
                };
            }

            const now = new Date();
            const targetYear = now.getFullYear();
            const targetMonth = now.getMonth();

            const filteredExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === targetMonth && 
                       expenseDate.getFullYear() === targetYear &&
                       (!expense.notes || !expense.notes.includes('[고정비 자동생성]'));
            });

            const categoryData = {};
            let total = 0;

            filteredExpenses.forEach(expense => {
                categoryData[expense.category] = (categoryData[expense.category] || 0) + expense.amount;
                total += expense.amount;
            });

            const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];
            const monthInfo = `${targetYear}년 ${monthNames[targetMonth]}`;

            return {
                categories: categoryData,
                total: total,
                monthInfo: monthInfo
            };
        }

        // 비교 데이터 가져오기
        function getComparisonData() {
            if (expenses.length === 0) {
                return {
                    thisMonth: { categories: {}, total: 0, monthInfo: '이번 달' },
                    lastMonth: { categories: {}, total: 0, monthInfo: '지난 달' }
                };
            }

            const now = new Date();
            const thisMonthDate = new Date(now.getFullYear(), now.getMonth());
            const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1);

            const thisMonthExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === thisMonthDate.getMonth() && 
                       expenseDate.getFullYear() === thisMonthDate.getFullYear();
            });

            const lastMonthExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === lastMonthDate.getMonth() && 
                       expenseDate.getFullYear() === lastMonthDate.getFullYear();
            });

            const thisMonthData = {};
            const lastMonthData = {};
            let thisMonthTotal = 0;
            let lastMonthTotal = 0;

            thisMonthExpenses.forEach(expense => {
                thisMonthData[expense.category] = (thisMonthData[expense.category] || 0) + expense.amount;
                thisMonthTotal += expense.amount;
            });

            lastMonthExpenses.forEach(expense => {
                lastMonthData[expense.category] = (lastMonthData[expense.category] || 0) + expense.amount;
                lastMonthTotal += expense.amount;
            });

            const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];

            return {
                thisMonth: {
                    categories: thisMonthData,
                    total: thisMonthTotal,
                    monthInfo: `${thisMonthDate.getFullYear()}년 ${monthNames[thisMonthDate.getMonth()]}`
                },
                lastMonth: {
                    categories: lastMonthData,
                    total: lastMonthTotal,
                    monthInfo: `${lastMonthDate.getFullYear()}년 ${monthNames[lastMonthDate.getMonth()]}`
                }
            };
        }

        // 파이 차트 그리기 (범례와 차트가 겹치지 않도록 개선)
        function drawPieChart(canvasId, data) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const centerX = 200; // 차트 중심을 왼쪽으로 이동
            const centerY = canvas.height / 2;
            const radius = 140; // 적절한 크기

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const categories = Object.keys(data);
            const total = Object.values(data).reduce((sum, val) => sum + val, 0);

            if (total === 0 || categories.length === 0) {
                ctx.font = '16px Malgun Gothic';
                ctx.fillStyle = '#7f8c8d';
                ctx.textAlign = 'center';
                ctx.fillText('지출 데이터가 없습니다', canvas.width / 2, centerY - 10);
                ctx.font = '14px Malgun Gothic';
                ctx.fillText('새 지출을 등록해보세요', canvas.width / 2, centerY + 15);
                return;
            }

            const colors = getChartColors();
            let currentAngle = -Math.PI / 2;

            // 파이 차트 그리기
            categories.forEach((category, index) => {
                const sliceAngle = (data[category] / total) * 2 * Math.PI;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.fillStyle = colors[index % colors.length];
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();

                // 퍼센트 라벨 (큰 조각만)
                if (sliceAngle > 0.15) {
                    const labelAngle = currentAngle + sliceAngle / 2;
                    const labelX = centerX + Math.cos(labelAngle) * (radius * 0.65);
                    const labelY = centerY + Math.sin(labelAngle) * (radius * 0.65);
                    const percentage = ((data[category] / total) * 100).toFixed(1);
                    
                    ctx.fillStyle = '#333';
                    ctx.font = 'bold 11px Malgun Gothic';
                    ctx.textAlign = 'center';
                    ctx.fillText(`${percentage}%`, labelX, labelY);
                }

                currentAngle += sliceAngle;
            });

            // 범례 그리기 (오른쪽 공간에 배치)
            drawLegend(ctx, canvas, categories, colors, data, total);
        }

        // 범례 그리기 (개선된 버전 - 차트와 겹치지 않음)
        function drawLegend(ctx, canvas, categories, colors, data, total) {
            const legendStartX = 380; // 차트 오른쪽 충분한 여백
            let legendY = 30;
            const legendItemHeight = 22;
            const maxVisibleItems = Math.floor((canvas.height - 80) / legendItemHeight);
            
            // 범례 배경
            const legendHeight = Math.min(categories.length * legendItemHeight + 25, canvas.height - 60);
            const legendWidth = 300;
            
            ctx.fillStyle = 'rgba(248, 249, 250, 0.98)';
            ctx.fillRect(legendStartX - 5, legendY - 10, legendWidth, legendHeight);
            ctx.strokeStyle = '#dee2e6';
            ctx.lineWidth = 1;
            ctx.strokeRect(legendStartX - 5, legendY - 10, legendWidth, legendHeight);
            
            // 범례 제목
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 14px Malgun Gothic';
            ctx.textAlign = 'left';
            ctx.fillText('카테고리별 지출 내역', legendStartX, legendY + 10);
            legendY += 30;
            
            // 범례 아이템들
            const visibleCategories = categories.slice(0, maxVisibleItems);
            ctx.font = '11px Malgun Gothic';
            
            visibleCategories.forEach((category, index) => {
                // 색상 박스
                ctx.fillStyle = colors[index % colors.length];
                ctx.fillRect(legendStartX, legendY - 6, 14, 14);
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1;
                ctx.strokeRect(legendStartX, legendY - 6, 14, 14);
                
                // 카테고리명
                ctx.fillStyle = '#2c3e50';
                ctx.font = 'bold 11px Malgun Gothic';
                const categoryText = category.length > 10 ? category.substring(0, 10) + '...' : category;
                ctx.fillText(categoryText, legendStartX + 20, legendY + 2);
                
                // 금액과 퍼센트
                const amount = data[category];
                const percentage = ((amount / total) * 100).toFixed(1);
                const amountText = `₩${amount.toLocaleString()}`; // 전체 원화 금액 표시
                
                ctx.fillStyle = '#6c757d';
                ctx.font = '10px Malgun Gothic';
                ctx.fillText(`${amountText} (${percentage}%)`, legendStartX + 20, legendY + 14);
                
                legendY += legendItemHeight;
            });
            
            // 더 많은 항목이 있는 경우 표시
            if (categories.length > maxVisibleItems) {
                ctx.fillStyle = '#6c757d';
                ctx.font = '10px Malgun Gothic';
                ctx.fillText(`...외 ${categories.length - maxVisibleItems}개 항목`, legendStartX + 20, legendY + 5);
            }
        }

        // 비교 막대 차트 그리기
        function drawComparisonBarChart(canvasId, lastMonthData, thisMonthData) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const allCategories = [...new Set([...Object.keys(lastMonthData), ...Object.keys(thisMonthData)])];
            
            if (allCategories.length === 0) {
                ctx.font = '16px Malgun Gothic';
                ctx.fillStyle = '#7f8c8d';
                ctx.textAlign = 'center';
                ctx.fillText('비교할 데이터가 없습니다', canvas.width / 2, canvas.height / 2);
                return;
            }

            const barWidth = 35;
            const maxAmount = Math.max(
                ...Object.values(lastMonthData),
                ...Object.values(thisMonthData),
                1
            );

            const chartHeight = canvas.height - 100;
            const chartTop = 60;
            const availableWidth = canvas.width - 100;
            const groupSpacing = Math.max(80, availableWidth / allCategories.length);

            // 차트 그리기
            allCategories.forEach((category, index) => {
                const x = 50 + index * groupSpacing;
                const lastAmount = lastMonthData[category] || 0;
                const thisAmount = thisMonthData[category] || 0;

                // 지난 달 막대 (파스텔 핑크)
                const lastBarHeight = (lastAmount / maxAmount) * chartHeight;
                ctx.fillStyle = '#FFB3BA';
                ctx.fillRect(x, chartTop + chartHeight - lastBarHeight, barWidth, lastBarHeight);

                // 이번 달 막대 (파스텔 블루)
                const thisBarHeight = (thisAmount / maxAmount) * chartHeight;
                ctx.fillStyle = '#BFEFFF';
                ctx.fillRect(x + barWidth + 8, chartTop + chartHeight - thisBarHeight, barWidth, thisBarHeight);

                // 카테고리 라벨
                ctx.fillStyle = '#2c3e50';
                ctx.font = '10px Malgun Gothic';
                ctx.textAlign = 'center';
                const categoryText = category.length > 8 ? category.substring(0, 8) + '...' : category;
                ctx.fillText(categoryText, x + barWidth, canvas.height - 25);
                
                // 금액 라벨 (막대 위에)
                ctx.font = '9px Malgun Gothic';
                ctx.fillStyle = '#666';
                if (lastAmount > 0) {
                    const lastAmountText = lastAmount >= 1000000 ? `₩${(lastAmount/1000000).toFixed(1)}M` : `₩${Math.round(lastAmount/1000)}K`;
                    ctx.fillText(lastAmountText, x + barWidth/2, chartTop + chartHeight - lastBarHeight - 5);
                }
                if (thisAmount > 0) {
                    const thisAmountText = thisAmount >= 1000000 ? `₩${(thisAmount/1000000).toFixed(1)}M` : `₩${Math.round(thisAmount/1000)}K`;
                    ctx.fillText(thisAmountText, x + barWidth + 8 + barWidth/2, chartTop + chartHeight - thisBarHeight - 5);
                }
            });

            // 범례
            const legendX = canvas.width - 150;
            ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
            ctx.fillRect(legendX - 10, 10, 140, 50);
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            ctx.strokeRect(legendX - 10, 10, 140, 50);

            ctx.fillStyle = '#FFB3BA';
            ctx.fillRect(legendX, 20, 15, 12);
            ctx.fillStyle = '#2c3e50';
            ctx.font = '12px Malgun Gothic';
            ctx.textAlign = 'left';
            ctx.fillText('지난 달', legendX + 20, 30);

            ctx.fillStyle = '#BFEFFF';
            ctx.fillRect(legendX, 40, 15, 12);
            ctx.fillText('이번 달', legendX + 20, 50);
        }

        // 파스텔톤 차트 색상 팔레트
        function getChartColors() {
            return [
                '#FFB3BA', // 파스텔 핑크
                '#BFEFFF', // 파스텔 블루
                '#FFFFBA', // 파스텔 옐로우
                '#BAEFBA', // 파스텔 그린
                '#E0BAFF', // 파스텔 퍼플
                '#FFDFBA', // 파스텔 오렌지
                '#BAF2FF', // 파스텔 사이안
                '#F0BAFF', // 파스텔 매젠타
                '#BAFFBA', // 파스텔 라임
                '#FFE5BA', // 파스텔 피치
                '#CABFFF', // 파스텔 라벤더
                '#BAFFDF', // 파스텔 민트
                '#FFBAD2', // 파스텔 로즈
                '#D2BAFF', // 파스텔 바이올렛
                '#BAFFE5'  // 파스텔 아쿠아
            ];
        }

        // 성공 메시지 표시
        function showSuccessMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #27ae60, #229954);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
                z-index: 1000;
                font-weight: 600;
                max-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            messageDiv.textContent = message;
            
            if (!document.getElementById('success-message-style')) {
                const style = document.createElement('style');
                style.id = 'success-message-style';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => {
                    if (document.body.contains(messageDiv)) {
                        document.body.removeChild(messageDiv);
                    }
                }, 300);
            }, 3000);
        }

        console.log('Firebase 지출관리 시스템이 초기화되었습니다.');
    </script>
</body>
</html>
export default CouponSettlementSystem;
