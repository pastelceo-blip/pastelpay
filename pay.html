<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회사 지출관리 시스템 - Firebase</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            font-weight: 300;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .auth-section {
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            margin-bottom: 20px;
        }

        .auth-section button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            margin: 0 10px;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .main-content {
            padding: 30px;
            display: none;
        }

        .main-content.authenticated {
            display: block;
        }
        
        .form-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
        }
        
        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        input, select, textarea {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .expense-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .expense-table th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .expense-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9em;
        }
        
        .expense-table tr:hover {
            background: #f8f9fa;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
            transition: transform 0.3s ease;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
        }
        
        .summary-card h4 {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .summary-card .amount {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        .delete-btn:hover {
            background: #c0392b;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .sync-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .sync-status.online {
            background: #d4edda;
            color: #155724;
        }

        .sync-status.offline {
            background: #f8d7da;
            color: #721c24;
        }

        .chart-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        
        .tab-btn:hover {
            color: #2980b9;
            background: #f8f9fa;
        }
        
        .chart-container {
            margin-top: 20px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
        }
        
        .chart-header h4 {
            color: #2c3e50;
            margin: 0;
        }
        
        .chart-total {
            font-weight: bold;
            color: #e74c3c;
            font-size: 1.1em;
        }

        .canvas-wrapper {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 450px;
            padding: 20px;
        }

        .canvas-wrapper canvas {
            max-width: 100%;
            height: auto;
        }

        .editable-row {
            cursor: pointer;
        }

        .editable-row:hover {
            background: #e8f4f8 !important;
        }

        .edit-input {
            width: 100%;
            padding: 4px 8px;
            border: 2px solid #3498db;
            border-radius: 4px;
            font-size: 0.9em;
            background: white;
        }

        .edit-select {
            width: 100%;
            padding: 4px 8px;
            border: 2px solid #3498db;
            border-radius: 4px;
            font-size: 0.9em;
            background: white;
        }

        .toggle-section {
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 2px solid #3498db;
        }

        .toggle-section:hover {
            color: #2980b9;
        }

        .toggle-icon {
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }

        .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            transition: max-height 0.3s ease, opacity 0.3s ease;
            overflow: hidden;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 5px;
                border-radius: 15px;
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .form-section {
                padding: 20px 15px;
                margin-bottom: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .summary-card {
                padding: 20px 15px;
            }
            
            .summary-card .amount {
                font-size: 1.5em;
            }
            
            .expense-table {
                font-size: 0.8em;
            }
            
            .expense-table th,
            .expense-table td {
                padding: 8px 6px;
            }

            .user-info {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>회사 지출관리 시스템</h1>
            <p>Firebase 기반 실시간 동기화로 더욱 안전한 지출 관리</p>
        </div>
        
        <!-- 인증 섹션 -->
        <div class="auth-section" id="authSection">
            <div class="loading" id="authLoading">Firebase 초기화 중...</div>
            <div id="signedOut" style="display: none;">
                <h3>로그인이 필요합니다</h3>
                <p>Google 계정으로 로그인하여 안전하게 지출 데이터를 관리하세요</p>
                <br>
                <button id="googleSignInBtn">Google 로그인</button>
            </div>
            <div id="signedIn" style="display: none;">
                <div class="user-info">
                    <div>
                        <span id="userName">사용자</span>님 안녕하세요
                        <span class="sync-status" id="syncStatus">연결 확인 중...</span>
                    </div>
                    <button id="signOutBtn">로그아웃</button>
                </div>
            </div>
        </div>
        
        <div class="main-content" id="mainContent">
            <!-- 요약 카드 -->
            <div class="summary-cards">
                <div class="summary-card">
                    <h4>총 지출액</h4>
                    <div class="amount" id="totalExpense">₩0</div>
                </div>
                <div class="summary-card">
                    <h4>이번 달 지출</h4>
                    <div class="amount" id="monthlyExpense">₩0</div>
                </div>
                <div class="summary-card">
                    <h4>이번 달 일반지출</h4>
                    <div class="amount" id="nonFixedExpense">₩0</div>
                </div>
                <div class="summary-card">
                    <h4>등록된 항목</h4>
                    <div class="amount" id="totalItems">0건</div>
                </div>
                <div class="summary-card">
                    <h4>월 고정비</h4>
                    <div class="amount" id="averageExpense">₩0</div>
                </div>
            </div>

            <!-- 카테고리별 차트 -->
            <div class="form-section">
                <h3>카테고리별 지출 분석</h3>
                <div class="chart-tabs">
                    <button class="tab-btn active" onclick="showChart('thisMonth')">전체 지출</button>
                    <button class="tab-btn" onclick="showChart('nonFixed')">일반 지출 (고정비 제외)</button>
                    <button class="tab-btn" onclick="showChart('comparison')">지난 달과 비교</button>
                </div>
                
                <!-- 전체 지출 차트 -->
                <div id="thisMonthChart" class="chart-container">
                    <div class="chart-header">
                        <h4>이번 달 카테고리별 지출</h4>
                        <span id="thisMonthTotal" class="chart-total">총 지출: ₩0</span>
                    </div>
                    <div class="canvas-wrapper">
                        <canvas id="thisMonthCanvas" width="450" height="450"></canvas>
                    </div>
                </div>
                
                <!-- 고정비 제외 차트 -->
                <div id="nonFixedChart" class="chart-container" style="display: none;">
                    <div class="chart-header">
                        <h4>이번 달 일반 지출 (고정비 제외)</h4>
                        <span id="nonFixedTotal" class="chart-total">일반 지출: ₩0</span>
                    </div>
                    <div class="canvas-wrapper">
                        <canvas id="nonFixedCanvas" width="450" height="450"></canvas>
                    </div>
                </div>
                
                <!-- 지난 달 비교 차트 -->
                <div id="comparisonChart" class="chart-container" style="display: none;">
                    <div class="chart-header">
                        <h4>지난 달 대비 카테고리별 지출 비교</h4>
                        <div>
                            <span id="lastMonthTotal" class="chart-total">지난 달: ₩0</span>
                            <span id="thisMonthTotalComp" class="chart-total">이번 달: ₩0</span>
                        </div>
                    </div>
                    <div class="canvas-wrapper">
                        <canvas id="comparisonCanvas" width="850" height="450"></canvas>
                    </div>
                </div>
            </div>

            <!-- 새 지출 등록 폼 -->
            <div class="form-section">
                <h3>새 지출 등록</h3>
                <form id="expenseForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date">날짜</label>
                            <input type="date" id="date" name="date" required>
                        </div>
                        <div class="form-group">
                            <label for="category">카테고리</label>
                            <select id="category" name="category" required>
                                <option value="">선택하세요</option>
                                <option value="사무용품">사무용품</option>
                                <option value="청첩장">청첩장</option>
                                <option value="식비">식비</option>
                                <option value="알바비">알바비</option>
                                <option value="액자">액자</option>
                                <option value="광고비">광고비</option>
                                <option value="마케팅">마케팅</option>
                                <option value="택배비">택배비</option>
                                <option value="이벤트">이벤트</option>
                                <option value="통신비">통신비</option>
                                <option value="임대료">임대료</option>
                                <option value="기타">기타</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="paymentMethod">결제 방식</label>
                            <select id="paymentMethod" name="paymentMethod" required>
                                <option value="">선택하세요</option>
                                <option value="법인카드">법인카드</option>
                                <option value="현금">현금</option>
                                <option value="계좌이체">계좌이체</option>
                                <option value="개인카드(정산)">개인카드(정산)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="description">지출 내역</label>
                            <input type="text" id="description" name="description" placeholder="구체적인 지출 내역을 입력하세요" required>
                        </div>
                        <div class="form-group">
                            <label for="amount">금액 (원)</label>
                            <input type="number" id="amount" name="amount" placeholder="0" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="notes">비고</label>
                            <input type="text" id="notes" name="notes" placeholder="추가 메모 (선택사항)">
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button type="submit" class="btn btn-success">지출 등록</button>
                    </div>
                </form>
            </div>
            
            <!-- 고정비 등록 폼 -->
            <div class="form-section">
                <h3>고정비 등록</h3>
                <form id="fixedExpenseForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fixedCategory">카테고리</label>
                            <select id="fixedCategory" name="fixedCategory" required>
                                <option value="">선택하세요</option>
                                <option value="임대료">임대료</option>
                                <option value="통신비">통신비</option>
                                <option value="세금">세금</option>
                                <option value="구독료">구독료</option>
                                <option value="유지보수비">유지보수비</option>
                                <option value="급여">급여</option>
                                <option value="기타 고정비">기타 고정비</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fixedDescription">고정비 내역</label>
                            <input type="text" id="fixedDescription" name="fixedDescription" placeholder="예: 사무실 임대료, 인터넷 요금 등" required>
                        </div>
                        <div class="form-group">
                            <label for="fixedAmount">월 금액 (원)</label>
                            <input type="number" id="fixedAmount" name="fixedAmount" placeholder="0" min="0" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fixedPaymentMethod">결제 방식</label>
                            <select id="fixedPaymentMethod" name="fixedPaymentMethod" required>
                                <option value="">선택하세요</option>
                                <option value="자동이체">자동이체</option>
                                <option value="법인카드">법인카드</option>
                                <option value="계좌이체">계좌이체</option>
                                <option value="현금">현금</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fixedStartDate">시작일</label>
                            <input type="date" id="fixedStartDate" name="fixedStartDate" required>
                        </div>
                        <div class="form-group">
                            <label for="fixedNotes">비고</label>
                            <input type="text" id="fixedNotes" name="fixedNotes" placeholder="추가 메모 (선택사항)">
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button type="submit" class="btn btn-success">고정비 등록</button>
                        <button type="button" id="generateMonthlyBtn" class="btn">이번 달 고정비 생성</button>
                    </div>
                </form>
            </div>
            
            <!-- 등록된 고정비 목록 -->
            <div class="form-section">
                <div class="toggle-section" onclick="toggleFixedExpenseList()">
                    <h3 style="margin: 0;">등록된 고정비</h3>
                    <span class="toggle-icon" id="fixedExpenseToggle">▼</span>
                </div>
                <div class="collapsible-content" id="fixedExpenseContent">
                    <div style="overflow-x: auto; margin-top: 20px;">
                        <table class="expense-table">
                            <thead>
                                <tr>
                                    <th>카테고리</th>
                                    <th>고정비 내역</th>
                                    <th>월 금액</th>
                                    <th>결제 방식</th>
                                    <th>시작일</th>
                                    <th>비고</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody id="fixedExpenseTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- 지출 내역 테이블 -->
            <div class="form-section">
                <h3>지출 내역</h3>
                <div style="overflow-x: auto;">
                    <table class="expense-table">
                        <thead>
                            <tr>
                                <th>날짜</th>
                                <th>카테고리</th>
                                <th>지출 내역</th>
                                <th>금액</th>
                                <th>결제 방식</th>
                                <th>비고</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody id="expenseTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase 설정 및 초기화
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, onSnapshot, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut as firebaseSignOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyAAXr7parhL6wQuUzy4MPvVhV6-J53wzcA",
            authDomain: "pastelmovie-cac7a.firebaseapp.com",
            databaseURL: "https://pastelmovie-cac7a-default-rtdb.firebaseio.com",
            projectId: "pastelmovie-cac7a",
            storageBucket: "pastelmovie-cac7a.firebasestorage.app",
            messagingSenderId: "543294016464",
            appId: "1:543294016464:web:47162285ca02d3cfb587d5",
            measurementId: "G-LK2Q13294B"
        };

        // Firebase 앱 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // 전역 변수
        let expenses = [];
        let fixedExpenses = [];
        let currentUser = null;
        let expenseUnsubscribe = null;
        let fixedExpenseUnsubscribe = null;
        let editingExpenseId = null;
        let editingFixedId = null;

        // 함수들을 전역으로 노출
        window.signInWithGoogle = signInWithGoogle;
        window.signOut = signOut;
        window.deleteExpenseById = deleteExpenseById;
        window.deleteFixedExpenseById = deleteFixedExpenseById;
        window.generateMonthlyExpenses = generateMonthlyExpenses;
        window.showChart = showChart;
        window.toggleFixedExpenseList = toggleFixedExpenseList;
        window.editExpense = editExpense;
        window.saveExpenseEdit = saveExpenseEdit;
        window.cancelExpenseEdit = cancelExpenseEdit;
        window.editFixedExpense = editFixedExpense;
        window.saveFixedExpenseEdit = saveFixedExpenseEdit;
        window.cancelFixedExpenseEdit = cancelFixedExpenseEdit;

        // 인증 상태 변경 감지
        onAuthStateChanged(auth, (user) => {
            const authLoading = document.getElementById('authLoading');
            const signedOut = document.getElementById('signedOut');
            const signedIn = document.getElementById('signedIn');
            const mainContent = document.getElementById('mainContent');
            const userName = document.getElementById('userName');

            authLoading.style.display = 'none';

            if (user) {
                currentUser = user;
                signedOut.style.display = 'none';
                signedIn.style.display = 'block';
                mainContent.classList.add('authenticated');
                userName.textContent = user.displayName || user.email;
                
                updateSyncStatus('online');
                setupRealtimeListeners();
                initializePage();
                
                console.log('사용자 로그인:', user.email);
            } else {
                currentUser = null;
                signedOut.style.display = 'block';
                signedIn.style.display = 'none';
                mainContent.classList.remove('authenticated');
                
                if (expenseUnsubscribe) expenseUnsubscribe();
                if (fixedExpenseUnsubscribe) fixedExpenseUnsubscribe();
                
                updateSyncStatus('offline');
                
                setTimeout(() => {
                    const googleSignInBtn = document.getElementById('googleSignInBtn');
                    const signOutBtn = document.getElementById('signOutBtn');
                    
                    if (googleSignInBtn) {
                        googleSignInBtn.addEventListener('click', signInWithGoogle);
                    }
                    
                    if (signOutBtn) {
                        signOutBtn.addEventListener('click', signOut);
                    }
                }, 100);
                
                console.log('사용자 로그아웃');
            }
        });

        // Google 로그인
        async function signInWithGoogle() {
            try {
                const result = await signInWithPopup(auth, provider);
                console.log('로그인 성공:', result.user.email);
            } catch (error) {
                console.error('로그인 오류:', error);
                alert('로그인 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 로그아웃
        async function signOut() {
            try {
                await firebaseSignOut(auth);
                expenses = [];
                fixedExpenses = [];
                console.log('로그아웃 성공');
            } catch (error) {
                console.error('로그아웃 오류:', error);
                alert('로그아웃 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 동기화 상태 업데이트
        function updateSyncStatus(status) {
            const syncStatus = document.getElementById('syncStatus');
            if (status === 'online') {
                syncStatus.textContent = '온라인';
                syncStatus.className = 'sync-status online';
            } else {
                syncStatus.textContent = '오프라인';
                syncStatus.className = 'sync-status offline';
            }
        }

        // 실시간 리스너 설정
        function setupRealtimeListeners() {
            if (!currentUser) return;

            const expensesQuery = query(
                collection(db, `users/${currentUser.uid}/expenses`),
                orderBy('date', 'desc')
            );

            expenseUnsubscribe = onSnapshot(expensesQuery, (snapshot) => {
                expenses = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                renderExpenseTable();
                updateSummary();
                console.log('지출 데이터 실시간 업데이트:', expenses.length, '건');
            });

            const fixedExpensesQuery = query(
                collection(db, `users/${currentUser.uid}/fixedExpenses`),
                orderBy('startDate', 'desc')
            );

            fixedExpenseUnsubscribe = onSnapshot(fixedExpensesQuery, (snapshot) => {
                fixedExpenses = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                renderFixedExpenseTable();
                updateSummary();
                console.log('고정비 데이터 실시간 업데이트:', fixedExpenses.length, '건');
            });
        }

        // 페이지 초기화
        function initializePage() {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('date');
            const fixedStartDateInput = document.getElementById('fixedStartDate');
            
            if (dateInput) dateInput.value = today;
            if (fixedStartDateInput) fixedStartDateInput.value = today;
            
            const expenseForm = document.getElementById('expenseForm');
            const fixedExpenseForm = document.getElementById('fixedExpenseForm');
            const generateMonthlyBtn = document.getElementById('generateMonthlyBtn');
            
            if (expenseForm) {
                expenseForm.removeEventListener('submit', handleFormSubmit);
                expenseForm.addEventListener('submit', handleFormSubmit);
            }
            
            if (fixedExpenseForm) {
                fixedExpenseForm.removeEventListener('submit', handleFixedExpenseSubmit);
                fixedExpenseForm.addEventListener('submit', handleFixedExpenseSubmit);
            }
            
            if (generateMonthlyBtn) {
                generateMonthlyBtn.onclick = generateMonthlyExpenses;
            }
        }

        // 지출 등록 폼 제출 처리
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            if (!currentUser) {
                alert('로그인이 필요합니다.');
                return;
            }
            
            const formData = new FormData(e.target);
            const expense = {
                date: formData.get('date'),
                category: formData.get('category'),
                description: formData.get('description'),
                amount: parseInt(formData.get('amount')),
                paymentMethod: formData.get('paymentMethod'),
                notes: formData.get('notes') || '',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            try {
                await addDoc(collection(db, `users/${currentUser.uid}/expenses`), expense);
                
                document.getElementById('expenseForm').reset();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('date').value = today;
                
                showSuccessMessage('지출이 성공적으로 등록되었습니다!');
                console.log('지출 등록 완료:', expense);
            } catch (error) {
                console.error('지출 등록 오류:', error);
                alert('지출 등록 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 고정비 등록 폼 제출 처리
        async function handleFixedExpenseSubmit(e) {
            e.preventDefault();
            
            if (!currentUser) {
                alert('로그인이 필요합니다.');
                return;
            }
            
            const formData = new FormData(e.target);
            const fixedExpense = {
                category: formData.get('fixedCategory'),
                description: formData.get('fixedDescription'),
                amount: parseInt(formData.get('fixedAmount')),
                paymentMethod: formData.get('fixedPaymentMethod'),
                startDate: formData.get('fixedStartDate'),
                notes: formData.get('fixedNotes') || '',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            try {
                await addDoc(collection(db, `users/${currentUser.uid}/fixedExpenses`), fixedExpense);
                
                document.getElementById('fixedExpenseForm').reset();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('fixedStartDate').value = today;
                
                showSuccessMessage('고정비가 성공적으로 등록되었습니다!');
                console.log('고정비 등록 완료:', fixedExpense);
            } catch (error) {
                console.error('고정비 등록 오류:', error);
                alert('고정비 등록 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 지출 삭제
        async function deleteExpenseById(expenseId) {
            if (!currentUser) {
                alert('로그인이 필요합니다.');
                return;
            }
            
            if (!expenseId) {
                alert('잘못된 ID입니다.');
                return;
            }
            
            if (confirm('정말 삭제하시겠습니까?')) {
                try {
                    await deleteDoc(doc(db, `users/${currentUser.uid}/expenses`, expenseId));
                    showSuccessMessage('지출이 삭제되었습니다.');
                    console.log('지출 삭제 완료:', expenseId);
                } catch (error) {
                    console.error('지출 삭제 오류:', error);
                    alert('지출 삭제 중 오류가 발생했습니다: ' + error.message);
                }
            }
        }

        // 고정비 삭제
        async function deleteFixedExpenseById(fixedId) {
            if (!currentUser) {
                alert('로그인이 필요합니다.');
                return;
            }
            
            if (!fixedId) {
                alert('잘못된 ID입니다.');
                return;
            }
            
            if (confirm('정말 삭제하시겠습니까?')) {
                try {
                    await deleteDoc(doc(db, `users/${currentUser.uid}/fixedExpenses`, fixedId));
                    showSuccessMessage('고정비가 삭제되었습니다.');
                    console.log('고정비 삭제 완료:', fixedId);
                } catch (error) {
                    console.error('고정비 삭제 오류:', error);
                    alert('고정비 삭제 중 오류가 발생했습니다: ' + error.message);
                }
            }
        }

        // 이번 달 고정비 생성
        async function generateMonthlyExpenses() {
            if (!currentUser) {
                alert('로그인이 필요합니다.');
                return;
            }
            
            if (fixedExpenses.length === 0) {
                alert('등록된 고정비가 없습니다.');
                return;
            }
            
            const now = new Date();
            const thisMonth = now.getMonth();
            const thisYear = now.getFullYear();
            
            // 이번 달에 이미 생성된 고정비들을 체크
            const existingThisMonth = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === thisMonth && 
                       expenseDate.getFullYear() === thisYear &&
                       expense.notes && expense.notes.includes('[고정비 자동생성]');
            });
            
            // 각 고정비별로 중복 체크를 위한 매핑 생성
            const existingFixedExpensesByDescription = new Set(
                existingThisMonth.map(expense => `${expense.category}-${expense.description}-${expense.amount}`)
            );
            
            let addedCount = 0;
            let skippedCount = 0;
            
            for (const fixed of fixedExpenses) {
                const fixedStartDate = new Date(fixed.startDate);
                
                if (fixedStartDate <= now) {
                    // 중복 체크용 키 생성
                    const duplicateCheckKey = `${fixed.category}-${fixed.description}-${fixed.amount}`;
                    
                    // 이미 존재하는지 확인
                    if (existingFixedExpensesByDescription.has(duplicateCheckKey)) {
                        skippedCount++;
                        console.log('중복된 고정비 건너뛰기:', fixed.description);
                        continue;
                    }
                    
                    const expense = {
                        date: new Date(thisYear, thisMonth, 1).toISOString().split('T')[0],
                        category: fixed.category,
                        description: fixed.description,
                        amount: fixed.amount,
                        paymentMethod: fixed.paymentMethod,
                        notes: fixed.notes ? `${fixed.notes} [고정비 자동생성]` : '[고정비 자동생성]',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    try {
                        await addDoc(collection(db, `users/${currentUser.uid}/expenses`), expense);
                        addedCount++;
                        // 추가 후 중복 체크 목록에 추가
                        existingFixedExpensesByDescription.add(duplicateCheckKey);
                        console.log('고정비 추가:', fixed.description);
                    } catch (error) {
                        console.error('고정비 생성 오류:', error);
                        alert('고정비 생성 중 오류가 발생했습니다: ' + error.message);
                        return;
                    }
                }
            }
            
            // 결과 메시지 표시
            let resultMessage = '';
            if (addedCount > 0) {
                resultMessage += `${addedCount}개의 고정비가 이번 달 지출로 추가되었습니다.`;
            }
            if (skippedCount > 0) {
                if (resultMessage) resultMessage += '\n';
                resultMessage += `${skippedCount}개의 고정비는 이미 존재하여 건너뛰었습니다.`;
            }
            
            if (addedCount > 0) {
                showSuccessMessage(resultMessage);
                console.log('고정비 생성 완료 - 추가:', addedCount, '개, 건너뜀:', skippedCount, '개');
            } else if (skippedCount > 0) {
                alert('모든 고정비가 이미 이번 달에 생성되어 있습니다.');
            } else {
                alert('추가할 고정비가 없습니다.');
            }
        }

        // 고정비 목록 토글
        function toggleFixedExpenseList() {
            const content = document.getElementById('fixedExpenseContent');
            const toggle = document.getElementById('fixedExpenseToggle');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.classList.remove('collapsed');
                toggle.textContent = '▼';
            } else {
                content.classList.add('collapsed');
                toggle.classList.add('collapsed');
                toggle.textContent = '▶';
            }
        }

        // 지출 수정 시작
        function editExpense(expenseId) {
            if (editingExpenseId) {
                cancelExpenseEdit();
            }
            editingExpenseId = expenseId;
            
            const expense = expenses.find(e => e.id === expenseId);
            if (!expense) return;
            
            const row = document.querySelector(`[data-expense-id="${expenseId}"]`).closest('tr');
            const cells = row.querySelectorAll('td');
            
            cells[0].innerHTML = `<input type="date" class="edit-input" value="${expense.date}" id="edit-date">`;
            cells[1].innerHTML = `
                <select class="edit-select" id="edit-category">
                    <option value="사무용품" ${expense.category === '사무용품' ? 'selected' : ''}>사무용품</option>
                    <option value="청첩장" ${expense.category === '청첩장' ? 'selected' : ''}>청첩장</option>
                    <option value="식비" ${expense.category === '식비' ? 'selected' : ''}>식비</option>
                    <option value="알바비" ${expense.category === '알바비' ? 'selected' : ''}>알바비</option>
                    <option value="액자" ${expense.category === '액자' ? 'selected' : ''}>액자</option>
                    <option value="광고비" ${expense.category === '광고비' ? 'selected' : ''}>광고비</option>
                    <option value="마케팅" ${expense.category === '마케팅' ? 'selected' : ''}>마케팅</option>
                    <option value="택배비" ${expense.category === '택배비' ? 'selected' : ''}>택배비</option>
                    <option value="이벤트" ${expense.category === '이벤트' ? 'selected' : ''}>이벤트</option>
                    <option value="통신비" ${expense.category === '통신비' ? 'selected' : ''}>통신비</option>
                    <option value="임대료" ${expense.category === '임대료' ? 'selected' : ''}>임대료</option>
                    <option value="기타" ${expense.category === '기타' ? 'selected' : ''}>기타</option>
                </select>
            `;
            cells[2].innerHTML = `<input type="text" class="edit-input" value="${expense.description}" id="edit-description">`;
            cells[3].innerHTML = `<input type="number" class="edit-input" value="${expense.amount}" id="edit-amount">`;
            cells[4].innerHTML = `
                <select class="edit-select" id="edit-paymentMethod">
                    <option value="법인카드" ${expense.paymentMethod === '법인카드' ? 'selected' : ''}>법인카드</option>
                    <option value="현금" ${expense.paymentMethod === '현금' ? 'selected' : ''}>현금</option>
                    <option value="계좌이체" ${expense.paymentMethod === '계좌이체' ? 'selected' : ''}>계좌이체</option>
                    <option value="개인카드(정산)" ${expense.paymentMethod === '개인카드(정산)' ? 'selected' : ''}>개인카드(정산)</option>
                </select>
            `;
            cells[5].innerHTML = `<input type="text" class="edit-input" value="${expense.notes}" id="edit-notes">`;
            cells[6].innerHTML = `
                <button class="btn" style="margin-right: 5px; padding: 5px 10px; font-size: 0.8em;" onclick="saveExpenseEdit('${expenseId}')">저장</button>
                <button class="btn-danger" style="padding: 5px 10px; font-size: 0.8em;" onclick="cancelExpenseEdit()">취소</button>
            `;
        }

        // 지출 수정 저장
        async function saveExpenseEdit(expenseId) {
            const updatedExpense = {
                date: document.getElementById('edit-date').value,
                category: document.getElementById('edit-category').value,
                description: document.getElementById('edit-description').value,
                amount: parseInt(document.getElementById('edit-amount').value),
                paymentMethod: document.getElementById('edit-paymentMethod').value,
                notes: document.getElementById('edit-notes').value,
                updatedAt: new Date().toISOString()
            };

            try {
                await updateDoc(doc(db, `users/${currentUser.uid}/expenses`, expenseId), updatedExpense);
                editingExpenseId = null;
                showSuccessMessage('지출이 수정되었습니다.');
                console.log('지출 수정 완료:', expenseId);
            } catch (error) {
                console.error('지출 수정 오류:', error);
                alert('지출 수정 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 지출 수정 취소
        function cancelExpenseEdit() {
            editingExpenseId = null;
            renderExpenseTable();
        }

        // 고정비 수정 시작
        function editFixedExpense(fixedId) {
            if (editingFixedId) {
                cancelFixedExpenseEdit();
            }
            editingFixedId = fixedId;
            
            const fixed = fixedExpenses.find(f => f.id === fixedId);
            if (!fixed) return;
            
            const row = document.querySelector(`[data-fixed-id="${fixedId}"]`).closest('tr');
            const cells = row.querySelectorAll('td');
            
            cells[0].innerHTML = `
                <select class="edit-select" id="edit-fixed-category">
                    <option value="임대료" ${fixed.category === '임대료' ? 'selected' : ''}>임대료</option>
                    <option value="통신비" ${fixed.category === '통신비' ? 'selected' : ''}>통신비</option>
                    <option value="세금" ${fixed.category === '세금' ? 'selected' : ''}>세금</option>
                    <option value="구독료" ${fixed.category === '구독료' ? 'selected' : ''}>구독료</option>
                    <option value="유지보수비" ${fixed.category === '유지보수비' ? 'selected' : ''}>유지보수비</option>
                    <option value="급여" ${fixed.category === '급여' ? 'selected' : ''}>급여</option>
                    <option value="기타 고정비" ${fixed.category === '기타 고정비' ? 'selected' : ''}>기타 고정비</option>
                </select>
            `;
            cells[1].innerHTML = `<input type="text" class="edit-input" value="${fixed.description}" id="edit-fixed-description">`;
            cells[2].innerHTML = `<input type="number" class="edit-input" value="${fixed.amount}" id="edit-fixed-amount">`;
            cells[3].innerHTML = `
                <select class="edit-select" id="edit-fixed-paymentMethod">
                    <option value="자동이체" ${fixed.paymentMethod === '자동이체' ? 'selected' : ''}>자동이체</option>
                    <option value="법인카드" ${fixed.paymentMethod === '법인카드' ? 'selected' : ''}>법인카드</option>
                    <option value="계좌이체" ${fixed.paymentMethod === '계좌이체' ? 'selected' : ''}>계좌이체</option>
                    <option value="현금" ${fixed.paymentMethod === '현금' ? 'selected' : ''}>현금</option>
                </select>
            `;
            cells[4].innerHTML = `<input type="date" class="edit-input" value="${fixed.startDate}" id="edit-fixed-startDate">`;
            cells[5].innerHTML = `<input type="text" class="edit-input" value="${fixed.notes}" id="edit-fixed-notes">`;
            cells[6].innerHTML = `
                <button class="btn" style="margin-right: 5px; padding: 5px 10px; font-size: 0.8em;" onclick="saveFixedExpenseEdit('${fixedId}')">저장</button>
                <button class="btn-danger" style="padding: 5px 10px; font-size: 0.8em;" onclick="cancelFixedExpenseEdit()">취소</button>
            `;
        }

        // 고정비 수정 저장
        async function saveFixedExpenseEdit(fixedId) {
            const updatedFixed = {
                category: document.getElementById('edit-fixed-category').value,
                description: document.getElementById('edit-fixed-description').value,
                amount: parseInt(document.getElementById('edit-fixed-amount').value),
                paymentMethod: document.getElementById('edit-fixed-paymentMethod').value,
                startDate: document.getElementById('edit-fixed-startDate').value,
                notes: document.getElementById('edit-fixed-notes').value,
                updatedAt: new Date().toISOString()
            };

            try {
                await updateDoc(doc(db, `users/${currentUser.uid}/fixedExpenses`, fixedId), updatedFixed);
                editingFixedId = null;
                showSuccessMessage('고정비가 수정되었습니다.');
                console.log('고정비 수정 완료:', fixedId);
            } catch (error) {
                console.error('고정비 수정 오류:', error);
                alert('고정비 수정 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 고정비 수정 취소
        function cancelFixedExpenseEdit() {
            editingFixedId = null;
            renderFixedExpenseTable();
        }

        // 테이블 렌더링
        function renderExpenseTable() {
            const tbody = document.getElementById('expenseTableBody');
            
            tbody.innerHTML = expenses.map((expense) => {
                return `
                    <tr class="editable-row" ondblclick="editExpense('${expense.id}')" title="더블클릭하여 수정">
                        <td>${new Date(expense.date).toLocaleDateString('ko-KR')}</td>
                        <td><span style="padding: 4px 8px; background: #e3f2fd; border-radius: 4px; font-size: 0.8em;">${expense.category}</span></td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${expense.description}</td>
                        <td style="text-align: right; font-weight: bold; color: #e74c3c;">₩${expense.amount.toLocaleString()}</td>
                        <td>${expense.paymentMethod}</td>
                        <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">${expense.notes}</td>
                        <td>
                            <button class="delete-btn" data-expense-id="${expense.id}">삭제</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const expenseId = e.target.getAttribute('data-expense-id');
                    deleteExpenseById(expenseId);
                });
            });
        }

        function renderFixedExpenseTable() {
            const tbody = document.getElementById('fixedExpenseTableBody');
            
            tbody.innerHTML = fixedExpenses.map((fixed) => {
                return `
                    <tr class="editable-row" ondblclick="editFixedExpense('${fixed.id}')" title="더블클릭하여 수정">
                        <td><span style="padding: 4px 8px; background: #fff3cd; border-radius: 4px; font-size: 0.8em;">${fixed.category}</span></td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${fixed.description}</td>
                        <td style="text-align: right; font-weight: bold; color: #f39c12;">₩${fixed.amount.toLocaleString()}</td>
                        <td>${fixed.paymentMethod}</td>
                        <td>${new Date(fixed.startDate).toLocaleDateString('ko-KR')}</td>
                        <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">${fixed.notes}</td>
                        <td>
                            <button class="delete-btn" data-fixed-id="${fixed.id}">삭제</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const fixedId = e.target.getAttribute('data-fixed-id');
                    deleteFixedExpenseById(fixedId);
                });
            });
        }

        // 요약 업데이트
        function updateSummary() {
            const total = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            
            const now = new Date();
            const thisMonthExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === now.getMonth() && 
                       expenseDate.getFullYear() === now.getFullYear();
            });
            
            const thisMonth = thisMonthExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            
            // 고정비 제외 계산
            const thisMonthNonFixed = thisMonthExpenses.filter(expense => 
                !expense.notes || !expense.notes.includes('[고정비 자동생성]')
            ).reduce((sum, expense) => sum + expense.amount, 0);
            
            const monthlyFixedTotal = fixedExpenses.reduce((sum, fixed) => sum + fixed.amount, 0);
            
            document.getElementById('totalExpense').textContent = `₩${total.toLocaleString()}`;
            document.getElementById('monthlyExpense').textContent = `₩${thisMonth.toLocaleString()}`;
            document.getElementById('nonFixedExpense').textContent = `₩${thisMonthNonFixed.toLocaleString()}`;
            document.getElementById('totalItems').textContent = `${expenses.length}건`;
            document.getElementById('averageExpense').textContent = `₩${monthlyFixedTotal.toLocaleString()}`;
            
            updateCharts();
        }

        // 차트 탭 전환
        function showChart(type) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('thisMonthChart').style.display = 'none';
            document.getElementById('nonFixedChart').style.display = 'none';
            document.getElementById('comparisonChart').style.display = 'none';
            
            if (type === 'thisMonth') {
                document.getElementById('thisMonthChart').style.display = 'block';
            } else if (type === 'nonFixed') {
                document.getElementById('nonFixedChart').style.display = 'block';
            } else {
                document.getElementById('comparisonChart').style.display = 'block';
            }
            
            updateCharts();
        }

        // 차트 업데이트
        function updateCharts() {
            drawThisMonthChart();
            drawNonFixedChart();
            drawComparisonChart();
        }

        // 이번 달 전체 차트 그리기
        function drawThisMonthChart() {
            const thisMonthData = getThisMonthData();
            const categoryData = thisMonthData.categories;
            const total = thisMonthData.total;
            const monthInfo = thisMonthData.monthInfo;

            document.getElementById('thisMonthTotal').textContent = 
                `${monthInfo} 총 지출: ₩${total.toLocaleString()}`;

            drawPieChart('thisMonthCanvas', categoryData);
        }

        // 고정비 제외 차트 그리기
        function drawNonFixedChart() {
            const nonFixedData = getNonFixedMonthData();
            const categoryData = nonFixedData.categories;
            const total = nonFixedData.total;
            const monthInfo = nonFixedData.monthInfo;

            document.getElementById('nonFixedTotal').textContent = 
                `${monthInfo} 일반 지출: ₩${total.toLocaleString()}`;

            drawPieChart('nonFixedCanvas', categoryData);
        }

        // 지난 달 비교 차트 그리기
        function drawComparisonChart() {
            const comparisonData = getComparisonData();
            
            const thisMonthData = comparisonData.thisMonth.categories;
            const lastMonthData = comparisonData.lastMonth.categories;
            const thisMonthTotal = comparisonData.thisMonth.total;
            const lastMonthTotal = comparisonData.lastMonth.total;

            document.getElementById('thisMonthTotalComp').textContent = 
                `${comparisonData.thisMonth.monthInfo}: ₩${thisMonthTotal.toLocaleString()}`;
            document.getElementById('lastMonthTotal').textContent = 
                `${comparisonData.lastMonth.monthInfo}: ₩${lastMonthTotal.toLocaleString()}`;

            drawComparisonBarChart('comparisonCanvas', lastMonthData, thisMonthData);
        }

        // 이번 달 전체 데이터 가져오기
        function getThisMonthData() {
            if (expenses.length === 0) {
                return {
                    categories: {},
                    total: 0,
                    monthInfo: '이번 달'
                };
            }

            const now = new Date();
            const targetYear = now.getFullYear();
            const targetMonth = now.getMonth();

            const filteredExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === targetMonth && 
                       expenseDate.getFullYear() === targetYear;
            });

            const categoryData = {};
            let total = 0;

            filteredExpenses.forEach(expense => {
                categoryData[expense.category] = (categoryData[expense.category] || 0) + expense.amount;
                total += expense.amount;
            });

            const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];
            const monthInfo = `${targetYear}년 ${monthNames[targetMonth]}`;

            return {
                categories: categoryData,
                total: total,
                monthInfo: monthInfo
            };
        }

        // 고정비 제외 데이터 가져오기
        function getNonFixedMonthData() {
            if (expenses.length === 0) {
                return {
                    categories: {},
                    total: 0,
                    monthInfo: '이번 달'
                };
            }

            const now = new Date();
            const targetYear = now.getFullYear();
            const targetMonth = now.getMonth();

            const filteredExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === targetMonth && 
                       expenseDate.getFullYear() === targetYear &&
                       (!expense.notes || !expense.notes.includes('[고정비 자동생성]'));
            });

            const categoryData = {};
            let total = 0;

            filteredExpenses.forEach(expense => {
                categoryData[expense.category] = (categoryData[expense.category] || 0) + expense.amount;
                total += expense.amount;
            });

            const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];
            const monthInfo = `${targetYear}년 ${monthNames[targetMonth]}`;

            return {
                categories: categoryData,
                total: total,
                monthInfo: monthInfo
            };
        }

        // 비교 데이터 가져오기
        function getComparisonData() {
            if (expenses.length === 0) {
                return {
                    thisMonth: { categories: {}, total: 0, monthInfo: '이번 달' },
                    lastMonth: { categories: {}, total: 0, monthInfo: '지난 달' }
                };
            }

            const now = new Date();
            const thisMonthDate = new Date(now.getFullYear(), now.getMonth());
            const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1);

            const thisMonthExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === thisMonthDate.getMonth() && 
                       expenseDate.getFullYear() === thisMonthDate.getFullYear();
            });

            const lastMonthExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === lastMonthDate.getMonth() && 
                       expenseDate.getFullYear() === lastMonthDate.getFullYear();
            });

            const thisMonthData = {};
            const lastMonthData = {};
            let thisMonthTotal = 0;
            let lastMonthTotal = 0;

            thisMonthExpenses.forEach(expense => {
                thisMonthData[expense.category] = (thisMonthData[expense.category] || 0) + expense.amount;
                thisMonthTotal += expense.amount;
            });

            lastMonthExpenses.forEach(expense => {
                lastMonthData[expense.category] = (lastMonthData[expense.category] || 0) + expense.amount;
                lastMonthTotal += expense.amount;
            });

            const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];

            return {
                thisMonth: {
                    categories: thisMonthData,
                    total: thisMonthTotal,
                    monthInfo: `${thisMonthDate.getFullYear()}년 ${monthNames[thisMonthDate.getMonth()]}`
                },
                lastMonth: {
                    categories: lastMonthData,
                    total: lastMonthTotal,
                    monthInfo: `${lastMonthDate.getFullYear()}년 ${monthNames[lastMonthDate.getMonth()]}`
                }
            };
        }

        // 파이 차트 그리기
        function drawPieChart(canvasId, data) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 100;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const categories = Object.keys(data);
            const total = Object.values(data).reduce((sum, val) => sum + val, 0);

            if (total === 0 || categories.length === 0) {
                ctx.font = '16px Malgun Gothic';
                ctx.fillStyle = '#7f8c8d';
                ctx.textAlign = 'center';
                ctx.fillText('지출 데이터가 없습니다', centerX, centerY - 10);
                ctx.font = '14px Malgun Gothic';
                ctx.fillText('새 지출을 등록해보세요', centerX, centerY + 15);
                return;
            }

            const colors = getChartColors();
            let currentAngle = -Math.PI / 2;

            categories.forEach((category, index) => {
                const sliceAngle = (data[category] / total) * 2 * Math.PI;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.fillStyle = colors[index % colors.length];
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 3;
                ctx.stroke();

                if (sliceAngle > 0.15) {
                    const labelAngle = currentAngle + sliceAngle / 2;
                    const labelX = centerX + Math.cos(labelAngle) * (radius * 0.7);
                    const labelY = centerY + Math.sin(labelAngle) * (radius * 0.7);
                    const percentage = ((data[category] / total) * 100).toFixed(1);
                    
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 12px Malgun Gothic';
                    ctx.textAlign = 'center';
                    ctx.fillText(`${percentage}%`, labelX, labelY);
                }

                currentAngle += sliceAngle;
            });

            drawLegend(ctx, canvas, categories, colors, data, total);
        }

        // 범례 그리기 (개선된 버전)
        function drawLegend(ctx, canvas, categories, colors, data, total) {
            const legendStartX = canvas.width - 180;
            const legendWidth = 160;
            let legendY = 30;
            
            // 범례 배경 그리기
            ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
            ctx.fillRect(legendStartX - 10, legendY - 15, legendWidth, categories.length * 40 + 20);
            ctx.strokeStyle = '#e9ecef';
            ctx.lineWidth = 1;
            ctx.strokeRect(legendStartX - 10, legendY - 15, legendWidth, categories.length * 40 + 20);
            
            ctx.font = '11px Malgun Gothic';
            ctx.textAlign = 'left';
            
            categories.forEach((category, index) => {
                // 색상 박스
                ctx.fillStyle = colors[index % colors.length];
                ctx.fillRect(legendStartX, legendY, 12, 12);
                
                // 텍스트
                ctx.fillStyle = '#2c3e50';
                const amount = data[category];
                const percentage = ((amount / total) * 100).toFixed(1);
                
                // 카테고리명 (길면 잘라내기)
                const categoryText = category.length > 8 ? category.substring(0, 8) + '...' : category;
                ctx.fillText(categoryText, legendStartX + 18, legendY + 10);
                
                // 금액과 퍼센트
                ctx.font = '10px Malgun Gothic';
                ctx.fillText(`₩${amount.toLocaleString()}`, legendStartX + 18, legendY + 22);
                ctx.fillText(`(${percentage}%)`, legendStartX + 18, legendY + 32);
                
                ctx.font = '11px Malgun Gothic';
                legendY += 40;
            });
        }

        // 비교 막대 차트 그리기
        function drawComparisonBarChart(canvasId, lastMonthData, thisMonthData) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const allCategories = [...new Set([...Object.keys(lastMonthData), ...Object.keys(thisMonthData)])];
            
            if (allCategories.length === 0) {
                ctx.font = '16px Malgun Gothic';
                ctx.fillStyle = '#7f8c8d';
                ctx.textAlign = 'center';
                ctx.fillText('비교할 데이터가 없습니다', canvas.width / 2, canvas.height / 2);
                return;
            }

            const barWidth = 30;
            const maxAmount = Math.max(
                ...Object.values(lastMonthData),
                ...Object.values(thisMonthData),
                1
            );

            const chartHeight = canvas.height - 80;
            const chartTop = 40;
            const groupSpacing = Math.min(80, (canvas.width - 100) / allCategories.length);

            allCategories.forEach((category, index) => {
                const x = 50 + index * groupSpacing;
                const lastAmount = lastMonthData[category] || 0;
                const thisAmount = thisMonthData[category] || 0;

                const lastBarHeight = (lastAmount / maxAmount) * chartHeight;
                ctx.fillStyle = '#95a5a6';
                ctx.fillRect(x, chartTop + chartHeight - lastBarHeight, barWidth, lastBarHeight);

                const thisBarHeight = (thisAmount / maxAmount) * chartHeight;
                ctx.fillStyle = '#3498db';
                ctx.fillRect(x + barWidth + 5, chartTop + chartHeight - thisBarHeight, barWidth, thisBarHeight);

                ctx.fillStyle = '#2c3e50';
                ctx.font = '10px Malgun Gothic';
                ctx.textAlign = 'center';
                const categoryText = category.length > 6 ? category.substring(0, 6) + '...' : category;
                ctx.fillText(categoryText, x + barWidth, canvas.height - 10);
            });

            // 범례
            ctx.fillStyle = '#95a5a6';
            ctx.fillRect(canvas.width - 150, 10, 20, 15);
            ctx.fillStyle = '#2c3e50';
            ctx.font = '14px Malgun Gothic';
            ctx.textAlign = 'left';
            ctx.fillText('지난 달', canvas.width - 125, 22);

            ctx.fillStyle = '#3498db';
            ctx.fillRect(canvas.width - 150, 30, 20, 15);
            ctx.fillText('이번 달', canvas.width - 125, 42);
        }

        // 차트 색상 팔레트
        function getChartColors() {
            return [
                '#3498db', '#e74c3c', '#f39c12', '#2ecc71', '#9b59b6',
                '#1abc9c', '#34495e', '#e67e22', '#95a5a6', '#f1c40f'
            ];
        }

        // 성공 메시지 표시
        function showSuccessMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #27ae60, #229954);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
                z-index: 1000;
                font-weight: 600;
                max-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            messageDiv.textContent = message;
            
            if (!document.getElementById('success-message-style')) {
                const style = document.createElement('style');
                style.id = 'success-message-style';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => {
                    if (document.body.contains(messageDiv)) {
                        document.body.removeChild(messageDiv);
                    }
                }, 300);
            }, 3000);
        }

        console.log('Firebase 지출관리 시스템이 초기화되었습니다.');
    </script>
</body>
</html>
